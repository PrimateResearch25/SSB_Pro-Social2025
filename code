Full code check: 
### Load Necessary Packages ###

library(tidyverse)
library(lubridate)
library(purrr)
library(tidyr)
library(readr)
library(dplyr)
library(glmmTMB)
library(igraph)
library(ggraph)
library(tidygraph)
library(grid) 
library(lme4)
library(lmerTest)
library(irr)




### Data Wrangling - control measures (encounter frequency, age, rank, observability) ###

## Data Wrangling - Encounter Frequency ##

scan_data <- read.csv("23_24_25_raw_scans.csv")

scan_data <- scan_data %>%
  mutate(
    date_mdy = suppressWarnings(mdy(DATE)),
    date_dmy = suppressWarnings(dmy(DATE))
  ) %>%
  mutate(
    DATE_parsed = case_when(
      month(date_mdy) %in% 1:5 ~ date_mdy,
      month(date_dmy) %in% 1:5 ~ date_dmy,
      TRUE ~ NA_Date_
    )
  )

exclude_pattern <- "^(FUN|JVUN|MUN|SAMUN|JVMUN|INFANT|JUV)$|\\(F\\)"
id_cols <- grep("^ID\\d*$", names(scan_data), value = TRUE)

scan_data$scan_row <- 1:nrow(scan_data)

long_scans <- scan_data %>%
  select(scan_row, all_of(id_cols)) %>%
  pivot_longer(cols = -scan_row, names_to = "slot", values_to = "id") %>%
  filter(!is.na(id)) %>%
  filter(!str_detect(id, exclude_pattern))

dyad_counts <- long_scans %>%
  group_by(scan_row) %>%
  summarise(
    present_ids = list(sort(unique(id))),
    .groups = "drop"
  ) %>%
  filter(lengths(present_ids) >= 2) %>%
  mutate(dyads = map(present_ids, ~ combn(.x, 2, simplify = FALSE))) %>%
  unnest(dyads) %>%
  mutate(
    id1 = map_chr(dyads, 1),
    id2 = map_chr(dyads, 2)
  ) %>%
  count(id1, id2, name = "encounter_count")

groom_mount_raw <- read_csv("raw_male_groom_mount_23_24_25.csv")
actor_cols <- c("actor1", "actor2", "actor3")
recipient_cols <- c("recipient1", "recipient2", "recipient3")

dyads_gm <- groom_mount_raw %>%
  filter(action %in% c("M", "Gr")) %>%
  rowwise() %>%
  do({
    row <- .
    pairs <- list()
    for (a in actor_cols) {
      for (r in recipient_cols) {
        actor <- as.character(row[[a]])
        recip <- as.character(row[[r]])
        if (!is.na(actor) && !is.na(recip) &&
            actor != recip &&
            !str_detect(actor, "FUN|JVUN|MUN|SAMUN|JVMUN|INFANT|\\(F\\)") &&
            !str_detect(recip, "FUN|JVUN|MUN|SAMUN|JVMUN|INFANT|\\(F\\)")) {
          id1 <- min(actor, recip)
          id2 <- max(actor, recip)
          pairs <- append(pairs, list(data.frame(id1, id2)))
        }
      }
    }
    bind_rows(pairs)
  }) %>%
  ungroup()

aggr_mount_raw <- read_csv("raw_male_aggression_mount_23_24_25.csv")

dyads_am <- aggr_mount_raw %>%
  filter(action %in% c("M", "Ag")) %>%
  rowwise() %>%
  do({
    row <- .
    pairs <- list()
    for (a in actor_cols) {
      for (r in recipient_cols) {
        actor <- as.character(row[[a]])
        recip <- as.character(row[[r]])
        if (!is.na(actor) && !is.na(recip) &&
            actor != recip &&
            !str_detect(actor, "FUN|JVUN|MUN|SAMUN|JVMUN|INFANT|\\(F\\)") &&
            !str_detect(recip, "FUN|JVUN|MUN|SAMUN|JVMUN|INFANT|\\(F\\)")) {
          id1 <- min(actor, recip)
          id2 <- max(actor, recip)
          pairs <- append(pairs, list(data.frame(id1, id2)))
        }
      }
    }
    bind_rows(pairs)
  }) %>%
  ungroup()

coalitions_raw <- read_csv("raw_male_coalition_mount_23_24_25.csv")

dyads_coalitions <- coalitions_raw %>%
  filter(action == "Ag") %>%
  rowwise() %>%
  do({
    row <- .
    pairs <- list()
    
    actor_ids <- c(as.character(row$actor1), as.character(row$actor2), as.character(row$actor3))
    actor_ids <- actor_ids[!is.na(actor_ids) &
                             !str_detect(actor_ids, "FUN|JVUN|MUN|SAMUN|JVMUN|INFANT|\\(F\\)")]
    if (length(actor_ids) >= 2) {
      actor_combos <- combn(sort(unique(actor_ids)), 2, simplify = FALSE)
      actor_pairs <- lapply(actor_combos, function(pair) data.frame(id1 = pair[1], id2 = pair[2]))
      pairs <- append(pairs, actor_pairs)
    }
    
    recipient_ids <- c(as.character(row$recipient1), as.character(row$recipient2), as.character(row$recipient3))
    recipient_ids <- recipient_ids[!is.na(recipient_ids) &
                                     !str_detect(recipient_ids, "FUN|JVUN|MUN|SAMUN|JVMUN|INFANT|\\(F\\)")]
    if (length(recipient_ids) >= 2) {
      recip_combos <- combn(sort(unique(recipient_ids)), 2, simplify = FALSE)
      recip_pairs <- lapply(recip_combos, function(pair) data.frame(id1 = pair[1], id2 = pair[2]))
      pairs <- append(pairs, recip_pairs)
    }
    
    bind_rows(pairs)
  }) %>%
  ungroup()

all_dyads <- bind_rows(dyads_gm, dyads_am, dyads_coalitions) %>%
  distinct()

write_csv(all_dyads, "all_dyads_23_24_25.csv")

all_dyads <- read.csv("all_dyads_23_24_25.csv")

all_dyads <- all_dyads %>%
  rowwise() %>%
  mutate(
    sorted = list(sort(c(id1, id2))),
    id1 = sorted[[1]],
    id2 = sorted[[2]]
  ) %>%
  select(-sorted) %>%
  ungroup() %>%
  distinct()

dyads_with_encounter_freq <- all_dyads %>%
  left_join(dyad_counts, by = c("id1", "id2")) %>%
  mutate(encounter_count = replace_na(encounter_count, 0))

write.csv(dyads_with_encounter_freq, "dyads_with_encounter_freq_23_24_25.csv", row.names = FALSE)



## Data Wrangling - David's Score (rank) ##

df <- read_csv("winner_loser_interactions_23_24_25.csv")
exclude_ids <- c("FUN", "SAMUN", "MUN", "JVUN", "JVMUN", "INFANT", "JUV", "JVFUN")

df$event_id <- seq_len(nrow(df))

actors_long <- df %>%
  select(event_id, action, starts_with("actor")) %>%
  pivot_longer(cols = starts_with("actor"), names_to = "actor_slot", values_to = "actor") %>%
  filter(!is.na(actor)) %>%
  filter(!actor %in% exclude_ids, !grepl("\\(F\\)", actor))

recipients_long <- df %>%
  select(event_id, starts_with("recipient")) %>%
  pivot_longer(cols = starts_with("recipient"), names_to = "recipient_slot", values_to = "recipient") %>%
  filter(!is.na(recipient)) %>%
  filter(!recipient %in% exclude_ids, !grepl("\\(F\\)", recipient))

dyads <- actors_long %>%
  inner_join(recipients_long, by = "event_id") %>%
  select(event_id, action, actor, recipient) %>%
  mutate(
    winner = case_when(
      action == "Ag" ~ actor,
      action == "Sub" ~ recipient,
      TRUE ~ NA_character_
    ),
    loser = case_when(
      action == "Ag" ~ recipient,
      action == "Sub" ~ actor,
      TRUE ~ NA_character_
    )
  ) %>%
  filter(!is.na(winner), !is.na(loser)) %>%
  select(winner, loser)

# David's Score
ids <- sort(unique(c(dyads$winner, dyads$loser)))
winmat <- matrix(0, nrow = length(ids), ncol = length(ids),
                 dimnames = list(ids, ids))

for (i in seq_len(nrow(dyads))) {
  w <- dyads$winner[i]
  l <- dyads$loser[i]
  winmat[w, l] <- winmat[w, l] + 1
}

total <- winmat + t(winmat)
Pij <- winmat / (total + .Machine$double.eps)
diag(Pij) <- 0

w <- rowSums(Pij)
l <- colSums(Pij)
w2 <- Pij %*% w
l2 <- t(Pij) %*% l
DS <- w + w2 - l - l2

ds_df <- data.frame(id = ids, davids_score = as.vector(DS))
write.csv(ds_df, "davids_scores_23_24_25.csv", row.names = FALSE)



## Data Wrangling - Observability ##

scan_data <- read.csv("23_24_25_raw_scans.csv")
scan_data[scan_data == ""] <- NA

scan_data <- scan_data %>%
  filter(!ID %in% c("MUN", "FUN", "SAMUN", "JVUN")) %>%
  mutate(
    date_dmy = suppressWarnings(dmy(DATE)),
    date_mdy = suppressWarnings(mdy(DATE)),
    date = case_when(
      !is.na(date_dmy) & month(date_dmy) %in% 2:5 ~ date_dmy,
      !is.na(date_mdy) & month(date_mdy) %in% 2:5 ~ date_mdy,
      TRUE ~ NA_Date_
    )
  )

scan_long <- scan_data %>%
  pivot_longer(cols = starts_with("ID"), names_to = "id_col", values_to = "ID") %>%
  filter(!is.na(ID), ID != "MUN")

test_study_periods <- function(data, period_lengths = c(7, 10, 12, 14, 21)) {
  results <- list()
  for (p in period_lengths) {
    df <- data %>%
      arrange(date) %>%
      mutate(
        start_date = min(date, na.rm = TRUE),
        period = floor(as.numeric(difftime(date, start_date, units = "days")) / p) + 1
      )
    summary <- df %>%
      group_by(period) %>%
      summarise(
        n_scans = n_distinct(date),
        unique_ids = n_distinct(ID),
        mean_LOS = mean(Obs_LOS, na.rm = TRUE),
        sd_LOS = sd(Obs_LOS, na.rm = TRUE),
        .groups = "drop"
      )
    results[[as.character(p)]] <- summary
  }
  results
}

study_periods <- test_study_periods(scan_long)

study_periods_combined <- purrr::imap_dfr(study_periods, ~{
  .x %>%
    mutate(window_size = as.integer(.y))
})

write.csv(study_periods_combined, "study_period_summary_23_24_25.csv", row.names = FALSE)

id_columns <- paste0("ID", c("", 2:20))
id_columns <- id_columns[id_columns %in% names(scan_data)]

scan_data <- scan_data %>%
  filter(!ID %in% c("MUN", "FUN", "SAMUN")) %>%
  arrange(date) %>%
  mutate(
    start_date = min(date, na.rm = TRUE),
    period = floor(as.numeric(difftime(date, start_date, units = "days")) / 10) + 1
  )

scan_long <- scan_data %>%
  select(date, Obs_LOS, period, all_of(id_columns)) %>%
  pivot_longer(cols = all_of(id_columns), names_to = "id_col", values_to = "ID") %>%
  filter(!is.na(ID), !ID %in% c("MUN", "FUN", "SAMUN"))

id_scan_counts <- scan_long %>%
  group_by(ID, period) %>%
  summarise(n_scans = n(), .groups = "drop")

los_by_period <- scan_data %>%
  group_by(period) %>%
  summarise(avg_LOS = mean(Obs_LOS, na.rm = TRUE), .groups = "drop")

id_period_data <- id_scan_counts %>%
  left_join(los_by_period, by = "period")

observability_df <- id_period_data %>%
  group_by(ID) %>%
  summarise(
    mean_scans = mean(n_scans, na.rm = TRUE),
    mean_LOS = mean(avg_LOS, na.rm = TRUE),
    observability = mean_scans / mean_LOS,
    .groups = "drop"
  )

observability_df$ID <- as.character(observability_df$ID)
write.csv(observability_df, "observability_scores_23_24_25.csv", row.names = FALSE)



## Data Wrangling - Combine Control Measures ##

aggr <- read_csv("raw_male_aggression_mount_23_24_25.csv")
groom <- read_csv("raw_male_groom_mount_23_24_25.csv")
coal  <- read_csv("raw_male_coalition_mount_23_24_25.csv")

cols <- c("actor1", "actor2", "actor3", "recipient1", "recipient2", "recipient3")

is_valid_male <- function(id) {
  !is.na(id) &&
    id != "" &&
    !str_ends(id, "\\(F\\)") &&
    !id %in% c("FUN", "MUN", "SAMUN", "JVUN", "JVMUN", "INFANT")
}

ids_groom_aggr <- bind_rows(
  groom %>% select(any_of(cols)),
  aggr %>% select(any_of(cols))
) %>%
  pivot_longer(cols = everything(), values_to = "id") %>%
  filter(is_valid_male(id)) %>%
  distinct(id)

coal_ids <- coal %>%
  select(any_of(cols)) %>%
  pivot_longer(cols = everything(), values_to = "id") %>%
  filter(is_valid_male(id)) %>%
  distinct(id)

all_ids <- bind_rows(ids_groom_aggr, coal_ids) %>%
  distinct(id)

rank <- read_csv("davids_scores_23_24_25.csv") %>%
  select(id, davids_score)

obs <- read_csv("observability_scores_23_24_25.csv") %>%
  rename(id = ID) %>%
  select(id, observability)

control_df <- all_ids %>%
  left_join(rank, by = "id") %>%
  left_join(obs, by = "id")

write_csv(control_df, "control_variables_23_24_25.csv")



## Note: Age was calculated in Excel from census DOB and added to this CSV. ##





### Socially complex animals exhibit a repertoire of social behaviours ###

## Grooming

control   <- read_csv("control_variables_23_24_25.csv")
raw_total <- read_csv("raw_groom_mount_23_24_25.csv")

is_excluded_id <- function(x) {
  is.na(x) | x == "" | grepl("FUN|MUN|SAMUN|JVUN|JVMUN|INFANT|\\(F\\)", x, ignore.case = TRUE)
}
is_adult_male <- function(x) !is_excluded_id(x)
is_female_id  <- function(x) grepl("FUN|\\(F\\)", x, ignore.case = TRUE)

make_focal_partner_with_role <- function(df) {
  act_long <- df |>
    mutate(event_id = dplyr::row_number()) |>
    pivot_longer(c(actor1, actor2, actor3), names_to = "actor_col", values_to = "actor_id") |>
    filter(!is.na(actor_id) & actor_id != "") |>
    select(event_id, action, actor_id)
  
  rec_long <- df |>
    mutate(event_id = dplyr::row_number()) |>
    pivot_longer(c(recipient1, recipient2, recipient3), names_to = "recipient_col", values_to = "recipient_id") |>
    filter(!is.na(recipient_id) & recipient_id != "") |>
    select(event_id, recipient_id)
  
  pairs <- inner_join(act_long, rec_long, by = "event_id")
  
  bind_rows(
    transmute(pairs, event_id, action, focal_id = actor_id,    partner_id = recipient_id, focal_role = "actor"),
    transmute(pairs, event_id, action, focal_id = recipient_id, partner_id = actor_id,    focal_role = "recipient")
  ) |>
    filter(focal_id != "" & partner_id != "")
}

pairs <- make_focal_partner_with_role(raw_total)

long <- pairs |>
  filter(is_adult_male(focal_id)) |>
  mutate(
    partner_is_adult_male = is_adult_male(partner_id),
    partner_is_female     = is_female_id(partner_id),
    is_mount_ssb = as.integer(action == "M" & partner_is_adult_male),                          
    is_mount_dsb = as.integer(action == "M" & focal_role == "actor" & partner_is_female),      
    is_groom_any = as.integer(action == "Gr")
  )

counts <- long |>
  summarise(
    ssb_count   = sum(is_mount_ssb),
    dsb_count   = sum(is_mount_dsb),
    total_mounts = ssb_count + dsb_count,
    groom_count = sum(is_groom_any),
    .by = focal_id
  ) |>
  mutate(
    SSB_prop = if_else(total_mounts > 0, ssb_count / total_mounts, 0)
  )

male_level <- counts |>
  left_join(control, by = dplyr::join_by(focal_id == id)) |>
  tidyr::drop_na(age, davids_score, observability)

m_groom_activity_composition <- glmmTMB(
  groom_count ~ total_mounts + SSB_prop + age + davids_score + observability,
  family = nbinom2,
  data   = male_level
)
summary(m_groom_activity_composition)



## Aggression

control   <- read_csv("control_variables_23_24_25.csv")
raw_total <- read_csv("raw_aggression_mount_23_24_25.csv")

is_excluded_id <- function(x) {
  is.na(x) | x == "" | grepl("FUN|MUN|SAMUN|JVUN|JVMUN|INFANT|\\(F\\)", x, ignore.case = TRUE)
}
is_adult_male <- function(x) !is_excluded_id(x)
is_female_id  <- function(x) grepl("FUN|\\(F\\)", x, ignore.case = TRUE)

make_focal_partner_with_role <- function(df) {
  act_long <- df |>
    mutate(event_id = dplyr::row_number()) |>
    pivot_longer(c(actor1, actor2, actor3), names_to = "actor_col", values_to = "actor_id") |>
    filter(!is.na(actor_id) & actor_id != "") |>
    select(event_id, action, actor_id)
  
  rec_long <- df |>
    mutate(event_id = dplyr::row_number()) |>
    pivot_longer(c(recipient1, recipient2, recipient3), names_to = "recipient_col", values_to = "recipient_id") |>
    filter(!is.na(recipient_id) & recipient_id != "") |>
    select(event_id, recipient_id)
  
  pairs <- inner_join(act_long, rec_long, by = "event_id")
  
  bind_rows(
    transmute(pairs, event_id, action, focal_id = actor_id,    partner_id = recipient_id, focal_role = "actor"),
    transmute(pairs, event_id, action, focal_id = recipient_id, partner_id = actor_id,    focal_role = "recipient")
  ) |>
    filter(focal_id != "" & partner_id != "")
}

pairs <- make_focal_partner_with_role(raw_total)

long <- pairs |>
  filter(is_adult_male(focal_id)) |>
  mutate(
    partner_is_adult_male = is_adult_male(partner_id),
    partner_is_female     = is_female_id(partner_id),
    is_mount_ssb = as.integer(action == "M" & partner_is_adult_male),                         
    is_mount_dsb = as.integer(action == "M" & focal_role == "actor" & partner_is_female),     
    is_aggr_any  = as.integer(action == "Ag")
  )

counts <- long |>
  summarise(
    ssb_count    = sum(is_mount_ssb),
    dsb_count    = sum(is_mount_dsb),
    total_mounts = ssb_count + dsb_count,
    aggression_count = sum(is_aggr_any),
    .by = focal_id
  ) |>
  mutate(
    SSB_prop = if_else(total_mounts > 0, ssb_count / total_mounts, 0)
  )

male_level <- counts |>
  left_join(control, by = dplyr::join_by(focal_id == id)) |>
  tidyr::drop_na(age, davids_score, observability)

m_aggr_activity_composition <- glmmTMB(
  aggression_count ~ total_mounts + SSB_prop + age + davids_score + observability,
  family = nbinom2,
  data   = male_level
)
summary(m_aggr_activity_composition)



## Coalitions

control   <- read_csv("control_variables_23_24_25.csv")
raw_total <- read_csv("raw_coalition_mount_23_24_25.csv")

is_excluded_id <- function(x) {
  is.na(x) | x == "" | grepl("FUN|MUN|SAMUN|JVUN|JVMUN|INFANT|\\(F\\)", x, ignore.case = TRUE)
}
is_adult_male <- function(x) !is_excluded_id(x)
is_female_id  <- function(x) grepl("FUN|\\(F\\)", x, ignore.case = TRUE)

make_mount_pairs_with_role <- function(df) {
  act_long <- df |>
    mutate(event_id = dplyr::row_number()) |>
    pivot_longer(c(actor1, actor2, actor3), names_to = "actor_col", values_to = "actor_id") |>
    filter(!is.na(actor_id) & actor_id != "") |>
    select(event_id, action, actor_id)
  
  rec_long <- df |>
    mutate(event_id = dplyr::row_number()) |>
    pivot_longer(c(recipient1, recipient2, recipient3), names_to = "recipient_col", values_to = "recipient_id") |>
    filter(!is.na(recipient_id) & recipient_id != "") |>
    select(event_id, recipient_id)
  
  pairs <- inner_join(act_long, rec_long, by = "event_id")
  
  bind_rows(
    transmute(pairs, event_id, action, focal_id = actor_id,    partner_id = recipient_id, focal_role = "actor"),
    transmute(pairs, event_id, action, focal_id = recipient_id, partner_id = actor_id,    focal_role = "recipient")
  )
}

make_coalition_same_side_pairs <- function(df) {
  df <- df |> mutate(event_id = dplyr::row_number())
  
  side_members <- bind_rows(
    df |> pivot_longer(c(actor1, actor2, actor3), names_to = "col", values_to = "id") |> mutate(side = "actor"),
    df |> pivot_longer(c(recipient1, recipient2, recipient3), names_to = "col", values_to = "id") |> mutate(side = "recipient")
  ) |>
    filter(!is.na(id) & id != "") |>
    select(event_id, action, side, id)
  
  same_side_pairs <- inner_join(
    side_members |> rename(id1 = id),
    side_members |> rename(id2 = id),
    by = c("event_id","action","side")
  ) |>
    filter(id1 != id2)
  
  bind_rows(
    transmute(same_side_pairs, event_id, action, focal_id = id1, partner_id = id2),
    transmute(same_side_pairs, event_id, action, focal_id = id2, partner_id = id1)
  )
}

mount  <- make_mount_pairs_with_role(raw_total) |> dplyr::filter(action == "M")
coal   <- make_coalition_same_side_pairs(raw_total) |> dplyr::filter(action == "Ag")

long <- dplyr::bind_rows(
  mount |> mutate(type = "mount"),
  coal  |> mutate(type  = "coal")
) |>
  dplyr::filter(is_adult_male(focal_id)) |>
  dplyr::mutate(
    partner_is_adult_male = is_adult_male(partner_id),
    partner_is_female     = is_female_id(partner_id),
    is_mount_ssb = as.integer(type == "mount" & partner_is_adult_male),                      
    is_mount_dsb = as.integer(type == "mount" & focal_role == "actor" & partner_is_female),  
    is_coal_any  = as.integer(type == "coal")
  )

counts <- long |>
  summarise(
    ssb_count    = sum(is_mount_ssb),
    dsb_count    = sum(is_mount_dsb),
    total_mounts = ssb_count + dsb_count,
    coalition_count = sum(is_coal_any),
    .by = focal_id
  ) |>
  mutate(
    SSB_prop = if_else(total_mounts > 0, ssb_count / total_mounts, 0)
  )

male_level <- counts |>
  left_join(control, by = dplyr::join_by(focal_id == id)) |>
  tidyr::drop_na(age, davids_score, observability)

m_coal_activity_composition <- glmmTMB(
  coalition_count ~ total_mounts + SSB_prop + age + davids_score + observability,
  family = nbinom2,
  data   = male_level
)
summary(m_coal_activity_composition)





### Male-male dyads which mount each other more also groom each other more, aggress each other less, and form more coalitions together ###

## Data wrangling - Pairs Dataset Prep. ##

# Grooming data
raw_data <- read.csv("raw_male_groom_mount_23_24_25.csv")

actor_cols <- c("actor1", "actor2", "actor3")
recipient_cols <- c("recipient1", "recipient2", "recipient3")

dyads <- raw_data %>%
  filter(action %in% c("M", "Gr")) %>%
  rowwise() %>%
  do({
    row <- .
    action_type <- row$action
    pairs <- list()
    
    for (a in actor_cols) {
      for (r in recipient_cols) {
        actor <- as.character(row[[a]])
        recip <- as.character(row[[r]])
        
        if (!is.na(actor) && !is.na(recip) &&
            actor != recip &&
            !str_detect(actor, "FUN") &&
            !str_detect(recip, "FUN")) {
          
          id1 <- min(actor, recip)
          id2 <- max(actor, recip)
          
          pairs <- append(pairs, list(data.frame(id1, id2, action = action_type)))
        }
      }
    }
    bind_rows(pairs)
  }) %>%
  ungroup()

clean_data <- dyads %>%
  count(id1, id2, action) %>%
  pivot_wider(
    names_from = action,
    values_from = n,
    values_fill = 0
  ) %>%
  rename(
    mount_count = M,
    groom_count = Gr
  )

write_csv(clean_data, "clean_male_dyads_grooming_mount_23_24_25.csv")


# Aggression Data
raw_data <- read_csv("raw_male_aggression_mount_23_24_25.csv")

actor_cols <- c("actor1", "actor2", "actor3")
recipient_cols <- c("recipient1", "recipient2", "recipient3")

is_unwanted <- function(id) {
  str_detect(id, "FUN|MUN|JVUN|JVMUN|SAMUN|INFANT|\\(F\\)")
}

dyads <- raw_data %>%
  filter(action %in% c("M", "Ag")) %>%
  rowwise() %>%
  do({
    row <- .
    action_type <- row$action
    pairs <- list()
    
    for (a in actor_cols) {
      for (r in recipient_cols) {
        actor <- as.character(row[[a]])
        recip <- as.character(row[[r]])
        
        if (!is.na(actor) && !is.na(recip) &&
            actor != recip &&
            !is_unwanted(actor) &&
            !is_unwanted(recip)) {
          
          id1 <- min(actor, recip)
          id2 <- max(actor, recip)
          
          pairs <- append(pairs, list(data.frame(id1, id2, action = action_type)))
        }
      }
    }
    bind_rows(pairs)
  }) %>%
  ungroup()

clean_data <- dyads %>%
  count(id1, id2, action) %>%
  pivot_wider(
    names_from = action,
    values_from = n,
    values_fill = 0
  ) %>%
  rename(
    mount_count = M,
    aggression_count = Ag
  )

write_csv(clean_data, "clean_male_dyads_aggression_mount_23_24_25.csv")


# Coalition Data
raw_data <- read_csv("raw_male_coalition_mount_23_24_25.csv")

actor_cols <- c("actor1", "actor2", "actor3")
recipient_cols <- c("recipient1", "recipient2", "recipient3")

is_unwanted <- function(id) {
  str_detect(id, "FUN|MUN|JVUN|JVMUN|SAMUN|INFANT|\\(F\\)")
}

dyads <- raw_data %>%
  filter(action %in% c("M", "Ag")) %>%  
  rowwise() %>%
  do({
    row <- .
    action_type <- row$action
    pairs <- list()
    
    if (action_type == "M") {
      for (a in actor_cols) {
        for (r in recipient_cols) {
          actor <- as.character(row[[a]])
          recip <- as.character(row[[r]])
          
          if (!is.na(actor) && !is.na(recip) &&
              actor != recip &&
              !is_unwanted(actor) &&
              !is_unwanted(recip)) {
            
            id1 <- min(actor, recip)
            id2 <- max(actor, recip)
            
            pairs <- append(pairs, list(data.frame(id1, id2, action = "M")))
          }
        }
      }
    } else if (action_type == "Ag") {
      actor_ids <- as.character(unlist(row[actor_cols]))
      actor_ids <- actor_ids[!is.na(actor_ids) & !is_unwanted(actor_ids)]
      
      if (length(actor_ids) >= 2) {
        actor_combos <- combn(sort(actor_ids), 2)
        for (i in 1:ncol(actor_combos)) {
          pairs <- append(pairs, list(data.frame(
            id1 = actor_combos[1, i],
            id2 = actor_combos[2, i],
            action = "Ag"
          )))
        }
      }
      
      recip_ids <- as.character(unlist(row[recipient_cols]))
      recip_ids <- recip_ids[!is.na(recip_ids) & !is_unwanted(recip_ids)]
      
      if (length(recip_ids) >= 2) {
        recip_combos <- combn(sort(recip_ids), 2)
        for (i in 1:ncol(recip_combos)) {
          pairs <- append(pairs, list(data.frame(
            id1 = recip_combos[1, i],
            id2 = recip_combos[2, i],
            action = "Ag"
          )))
        }
      }
    }
    
    bind_rows(pairs)
  }) %>%
  ungroup()

clean_data <- dyads %>%
  count(id1, id2, action) %>%
  pivot_wider(
    names_from = action,
    values_from = n,
    values_fill = 0
  ) %>%
  rename(
    mount_count = M,
    coalition_count = Ag
  )

write_csv(clean_data, "clean_male_dyads_coalition_mount_23_24_25.csv")



## Merge Pair-Level Controls 

# Grooming
dyads <- read_csv("clean_male_dyads_grooming_mount_23_24_25.csv")
controls <- read_csv("control_variables_23_24_25.csv")  
encounters <- read_csv("dyads_with_encounter_freq_23_24_25.csv")  

dyads_controls <- dyads %>%
  left_join(controls, by = c("id1" = "id")) %>%
  rename(age1 = age, rank1 = davids_score, obs1 = observability) %>%
  left_join(controls, by = c("id2" = "id")) %>%
  rename(age2 = age, rank2 = davids_score, obs2 = observability)

dyads_controls <- dyads_controls %>%
  mutate(
    abs_age_diff = abs(age1 - age2),
    abs_rank_diff = abs(rank1 - rank2),
    min_observability = pmin(obs1, obs2, na.rm = TRUE)
  )

dyads_final <- dyads_controls %>%
  left_join(encounters, by = c("id1", "id2"))

write_csv(dyads_final, "groom_mount_dyads_with_controls.csv")


# Aggression
aggr_dyads <- read_csv("clean_male_dyads_aggression_mount_23_24_25.csv")
controls <- read_csv("control_variables_23_24_25.csv")  
encounters <- read_csv("dyads_with_encounter_freq_23_24_25.csv")  

aggr_controls <- aggr_dyads %>%
  left_join(controls, by = c("id1" = "id")) %>%
  rename(age1 = age, rank1 = davids_score, obs1 = observability) %>%
  left_join(controls, by = c("id2" = "id")) %>%
  rename(age2 = age, rank2 = davids_score, obs2 = observability)

aggr_controls <- aggr_controls %>%
  mutate(
    abs_age_diff = abs(age1 - age2),
    abs_rank_diff = abs(rank1 - rank2),
    min_observability = pmin(obs1, obs2, na.rm = TRUE)
  )

aggr_final <- aggr_controls %>%
  left_join(encounters, by = c("id1", "id2"))

write_csv(aggr_final, "aggression_mount_dyads_with_controls.csv")


# Coalitions
coal_dyads <- read_csv("clean_male_dyads_coalition_mount_23_24_25.csv")
controls <- read_csv("control_variables_23_24_25.csv")  
encounters <- read_csv("dyads_with_encounter_freq_23_24_25.csv")  

coal_controls <- coal_dyads %>%
  left_join(controls, by = c("id1" = "id")) %>%
  rename(age1 = age, rank1 = davids_score, obs1 = observability) %>%
  left_join(controls, by = c("id2" = "id")) %>%
  rename(age2 = age, rank2 = davids_score, obs2 = observability)

coal_controls <- coal_controls %>%
  mutate(
    abs_age_diff = abs(age1 - age2),
    abs_rank_diff = abs(rank1 - rank2),
    min_observability = pmin(obs1, obs2, na.rm = TRUE)
  )

coal_final <- coal_controls %>%
  left_join(encounters, by = c("id1", "id2"))

write_csv(coal_final, "coalition_mount_dyads_with_controls.csv")



## Grooming

df_clean <- read_csv("groom_mount_dyads_with_controls.csv")

df_model <- df_clean %>%
  filter(
    !is.na(mount_count),
    !is.na(groom_count),
    !is.na(encounter_count),
    !is.na(abs_age_diff),
    !is.na(abs_rank_diff),
    !is.na(min_observability)
  )

cor(df_model[c("groom_count", "encounter_count", "abs_age_diff", "abs_rank_diff", "min_observability")], use = "complete.obs")

groom_dyads <- glmmTMB(
  mount_count ~ groom_count + encounter_count + abs_age_diff + abs_rank_diff,
  family = nbinom2,
  data = df_model
)

summary(groom_dyads)



## Aggression

df_aggr <- read_csv("aggression_mount_dyads_with_controls.csv")

df_model_aggr <- df_aggr %>%
  filter(
    !is.na(mount_count),
    !is.na(aggression_count),
    !is.na(encounter_count),
    !is.na(abs_age_diff),
    !is.na(abs_rank_diff)
  )


aggr_dyads <- glmmTMB(
  mount_count ~ aggression_count + encounter_count + abs_age_diff + abs_rank_diff,
  family = nbinom2,
  data = df_model_aggr
)

summary(aggr_dyads)



## Coalitions

dyads_file  <- "coalition_mount_dyads_with_controls.csv"
ag_file     <- "raw_male_aggression_mount_23_24_25.csv"

dyads <- read_csv(dyads_file, show_col_types = FALSE)

ag_raw <- read_csv(ag_file, show_col_types = FALSE) %>%
  filter(action == "Ag") %>%
  mutate(evt = row_number())  

actor_cols     <- grep("^actor\\d+$",     names(ag_raw), value = TRUE)
recipient_cols <- grep("^recipient\\d+$", names(ag_raw), value = TRUE)
if (length(actor_cols) == 0L && length(recipient_cols) == 0L) {
  stop("No actor*/recipient* columns found in aggression file.")
}

ag_totals <- bind_rows(
  ag_raw %>% pivot_longer(all_of(actor_cols),     names_to = "role", values_to = "ID"),
  ag_raw %>% pivot_longer(all_of(recipient_cols), names_to = "role", values_to = "ID")
) %>%
  filter(!is.na(ID), ID != "") %>%
  distinct(evt, ID) %>%          
  count(ID, name = "aggr_total") 

df <- dyads %>%
  left_join(ag_totals, by = c("id1" = "ID")) %>% rename(aggr_id1 = aggr_total) %>%
  left_join(ag_totals, by = c("id2" = "ID")) %>% rename(aggr_id2 = aggr_total) %>%
  mutate(
    aggr_id1 = coalesce(aggr_id1, 0L),
    aggr_id2 = coalesce(aggr_id2, 0L),
    aggr_total_pair = aggr_id1 + aggr_id2
  ) %>%
  filter(
    !is.na(mount_count),
    !is.na(coalition_count),
    !is.na(encounter_count),
    !is.na(abs_age_diff),
    !is.na(abs_rank_diff)
  )

coal_dyads <- glmmTMB(
  mount_count ~ coalition_count + aggr_total_pair + encounter_count + abs_age_diff + abs_rank_diff,
  family = nbinom2,
  data   = df
)

summary(coal_dyads)



## Coalition and Rank (Supplementary Check) 

events_file  <- "raw_male_coalition_mount_23_24_25.csv"   
controls_file <- "control_variables_23_24_25.csv"          

events   <- read_csv(events_file, show_col_types = FALSE)
controls <- read_csv(controls_file, show_col_types = FALSE) %>%
  dplyr::select(id, age, davids_score, observability)

ag <- events %>%
  dplyr::filter(action == "Ag") %>%
  dplyr::mutate(evt = dplyr::row_number())

actor_cols     <- grep("^actor\\d+$",     names(ag), value = TRUE)
recipient_cols <- grep("^recipient\\d+$", names(ag), value = TRUE)

if (length(actor_cols) == 0L || length(recipient_cols) == 0L) {
  stop("Couldn't find columns named like actor1/actor2... and recipient1/recipient2... in the Ag data.")
}

ag_coal <- ag %>%
  dplyr::mutate(
    n_actor = rowSums(dplyr::across(dplyr::all_of(actor_cols), ~ !is.na(.x) & .x != "")),
    n_rec   = rowSums(dplyr::across(dplyr::all_of(recipient_cols), ~ !is.na(.x) & .x != "")),
    coal_side = dplyr::case_when(
      n_actor >= 2 & n_rec <= 1 ~ "actor",
      n_rec   >= 2 & n_actor <= 1 ~ "recipient",
      TRUE ~ NA_character_
    )
  ) %>%
  dplyr::filter(!is.na(coal_side))

coal_parts <- dplyr::bind_rows(
  ag_coal %>%
    dplyr::filter(coal_side == "actor") %>%
    tidyr::pivot_longer(cols = dplyr::all_of(actor_cols), names_to = "role", values_to = "ID"),
  ag_coal %>%
    dplyr::filter(coal_side == "recipient") %>%
    tidyr::pivot_longer(cols = dplyr::all_of(recipient_cols), names_to = "role", values_to = "ID")
) %>%
  dplyr::filter(!is.na(ID), ID != "") %>%
  dplyr::distinct(evt, ID)

coal_counts <- coal_parts %>%
  dplyr::count(ID, name = "coalition_count")

dat <- controls %>%
  dplyr::rename(ID = id) %>%
  dplyr::left_join(coal_counts, by = "ID") %>%
  dplyr::mutate(
    coalition_count = dplyr::if_else(
      !is.na(observability) & observability > 0 & is.na(coalition_count),
      0L,
      as.integer(coalition_count)
    )
  ) %>%
  dplyr::filter(stats::complete.cases(age, davids_score, observability, coalition_count))

mod_coal_rank <- glmmTMB(
  coalition_count ~ davids_score + age + observability,
  family = nbinom2,
  data   = dat
)
summary(mod_coal_rank)





### In mounting pairs, the mounter also tend to be the recipient of grooming and initiator of aggression ###

## Data wrangling

# Clean data
invalid_ids <- c("FUN", "MUN", "SAMUN", "JVUN", "INFANT", "JVMUN")

filter_valid_dyads <- function(df, actor_col, recipient_col) {
  df %>%
    filter(
      !is.na(.data[[actor_col]]),
      !is.na(.data[[recipient_col]]),
      !.data[[actor_col]] %in% invalid_ids,
      !.data[[recipient_col]] %in% invalid_ids,
      !grepl("\\(F\\)", .data[[actor_col]]),   
      !grepl("\\(F\\)", .data[[recipient_col]])
    )
}


# Create grooming dataset
groom_mount <- read_csv("raw_male_groom_mount_23_24_25.csv")

grooming <- groom_mount %>%
  filter(action == "Gr") %>%
  filter_valid_dyads("actor1", "recipient1") %>%
  transmute(actor = actor1,
            recipient = recipient1,
            dyad = paste0(actor, "→", recipient),
            action = "groom") %>%
  filter(actor != recipient)

mounting <- groom_mount %>%
  filter(action == "M") %>%
  filter_valid_dyads("actor1", "recipient1") %>%
  transmute(actor = actor1,
            recipient = recipient1,
            dyad = paste0(actor, "→", recipient),
            action = "mount") %>%
  filter(actor != recipient)

groom_mount_summary <- bind_rows(grooming, mounting) %>%
  group_by(dyad, actor, recipient, action) %>%
  summarise(count = n(), .groups = "drop")

write_csv(groom_mount_summary, "directional_groom_mount_dyads.csv")


# Create aggression dataset
aggr_mount <- read_csv("raw_male_aggression_mount_23_24_25.csv")

actor_cols <- c("actor1", "actor2", "actor3")
recipient_cols <- c("recipient1", "recipient2", "recipient3")

expand_dyads <- function(df, action_code) {
  df_action <- df %>% filter(action == action_code)
  
  expand.grid(
    actor = df_action[actor_cols],
    recipient = df_action[recipient_cols],
    stringsAsFactors = FALSE
  ) %>%
    unlist() %>%
    matrix(ncol = 2, byrow = TRUE, dimnames = list(NULL, c("actor", "recipient"))) %>%
    as.data.frame() %>%
    filter_valid_dyads("actor", "recipient") %>%
    filter(actor != recipient) %>%
    mutate(dyad = paste0(actor, "→", recipient),
           action = ifelse(action_code == "Ag", "aggression", "mount"))
}

aggr_expanded <- expand_dyads(aggr_mount, "Ag")
mount_expanded <- expand_dyads(aggr_mount, "M")

aggr_mount_summary <- bind_rows(aggr_expanded, mount_expanded) %>%
  group_by(dyad, actor, recipient, action) %>%
  summarise(count = n(), .groups = "drop")

write_csv(aggr_mount_summary, "directional_aggr_mount_dyads.csv")



## Filter dyadic roles

# Grooming and mounting
groom_mount <- read.csv("directional_groom_mount_dyads.csv")

mounts_groom <- groom_mount %>%
  filter(action == "mount") %>%
  filter(!is.na(actor), !is.na(recipient), actor != recipient) %>%
  group_by(actor, recipient) %>%
  summarise(mount_count = sum(count), .groups = "drop") %>%
  mutate(dyad_pair = if_else(actor < recipient,
                             paste(actor, recipient, sep = "_"),
                             paste(recipient, actor, sep = "_"))) %>%
  group_by(dyad_pair) %>%
  slice_max(order_by = mount_count, n = 1) %>%
  ungroup() %>%
  rename(mounter = actor, mountee = recipient)

grooms <- groom_mount %>%
  filter(action == "groom") %>%
  filter(!is.na(actor), !is.na(recipient), actor != recipient) %>%
  group_by(actor, recipient) %>%
  summarise(groom_count = sum(count), .groups = "drop") %>%
  mutate(dyad_pair = if_else(actor < recipient,
                             paste(actor, recipient, sep = "_"),
                             paste(recipient, actor, sep = "_")))

mount_groom_merged <- mounts_groom %>%
  left_join(grooms, by = "dyad_pair") %>%
  mutate(
    mounter_is_groomer = mounter == actor,
    mounter_is_groomee = mounter == recipient,
    mountee_is_groomer = mountee == actor,
    mountee_is_groomee = mountee == recipient
  )

write.csv(mount_groom_merged, "mount_groom_dyadic_roles.csv", row.names = FALSE)


# Aggression and mounting
aggr_mount_summary <- read.csv("directional_aggr_mount_dyads.csv")

mounts_aggr <- aggr_mount_summary %>%
  filter(action == "mount") %>%
  filter(actor != recipient) %>%
  group_by(actor, recipient) %>%
  summarise(mount_count = n(), .groups = "drop") %>%
  mutate(dyad_pair = if_else(actor < recipient,
                             paste(actor, recipient, sep = "_"),
                             paste(recipient, actor, sep = "_"))) %>%
  group_by(dyad_pair) %>%
  slice_max(order_by = mount_count, n = 1, with_ties = FALSE) %>%
  ungroup() %>%
  rename(mounter = actor, mountee = recipient)

aggs <- aggr_mount_summary %>%
  filter(action == "aggression") %>%
  filter(actor != recipient) %>%
  group_by(actor, recipient) %>%
  summarise(aggr_count = n(), .groups = "drop") %>%
  mutate(dyad_pair = if_else(actor < recipient,
                             paste(actor, recipient, sep = "_"),
                             paste(recipient, actor, sep = "_")))

mount_aggr_merged <- mounts_aggr %>%
  left_join(aggs, by = "dyad_pair") %>%
  mutate(
    mounter_is_aggressor = mounter == actor,
    mounter_is_recipient = mounter == recipient,
    mountee_is_aggressor = mountee == actor,
    mountee_is_recipient = mountee == recipient
  )

write.csv(mount_aggr_merged, "mount_aggr_dyadic_roles.csv", row.names = FALSE)



## Merge control variables

# Grooming and mounting dataset
dyads <- read.csv("mount_groom_dyadic_roles.csv")

controls <- read.csv("control_variables_23_24_25.csv") %>%
  filter(!is.na(id)) %>%
  select(id, age, rank = davids_score, observability)

dyads <- dyads %>%
  left_join(controls, by = c("mounter" = "id")) %>%
  rename(mounter_age = age, mounter_rank = rank, mounter_obs = observability)

dyads <- dyads %>%
  left_join(controls, by = c("mountee" = "id")) %>%
  rename(mountee_age = age, mountee_rank = rank, mountee_obs = observability)

dyads <- dyads %>%
  mutate(
    age_diff = mounter_age - mountee_age,
    rank_diff = mounter_rank - mountee_rank,
    obs_diff = mounter_obs - mountee_obs
  )

write.csv(dyads, "mount_groom_dyadic_roles_with_controls.csv", row.names = FALSE)


# Aggression and mounting dataset
dyads <- read.csv("mount_aggr_dyadic_roles.csv")

controls <- read.csv("control_variables_23_24_25.csv") %>%
  filter(!is.na(id)) %>%
  select(id, age, rank = davids_score, observability)

dyads <- dyads %>%
  left_join(controls, by = c("mounter" = "id")) %>%
  rename(mounter_age = age, mounter_rank = rank, mounter_obs = observability)

dyads <- dyads %>%
  left_join(controls, by = c("mountee" = "id")) %>%
  rename(mountee_age = age, mountee_rank = rank, mountee_obs = observability)

dyads <- dyads %>%
  mutate(
    age_diff = mounter_age - mountee_age,
    rank_diff = mounter_rank - mountee_rank,
    obs_diff = mounter_obs - mountee_obs
  )

write.csv(dyads, "mount_aggr_dyadic_roles_with_controls.csv", row.names = FALSE)



## Run models

# Grooming
groom_data <- read.csv("mount_groom_dyadic_roles_with_controls.csv")

groom_data <- groom_data %>%
  mutate(across(c(age_diff, rank_diff, obs_diff), scale))

model1 <- glmmTMB(mounter_is_groomer ~ age_diff + rank_diff + obs_diff,
                  data = groom_data, family = binomial)

summary(model1)

plogis(-0.06879)


# Aggression
aggr_data <- read.csv("mount_aggr_dyadic_roles_with_controls.csv")

aggr_data <- aggr_data %>%
  mutate(across(c(age_diff, rank_diff, obs_diff), scale))

model3 <- glmmTMB(mounter_is_aggressor ~ age_diff + rank_diff + obs_diff,
                  data = aggr_data, family = binomial)

summary(model3)

plogis(-0.61121)





### Individuals with higher SSB counts sit more centrally within the affiliative network ###

## SSB count

raw <- read.csv("raw_male_groom_mount_23_24_25.csv")  
controls <- read_csv("control_variables_23_24_25.csv", show_col_types = FALSE) %>%
  select(id, age, davids_score, observability)

build_group_df <- function(g_label) {
  dat_g <- raw %>% filter(group == g_label)
  
  edges_g <- dat_g %>%
    filter(action == "Gr") %>%
    group_by(giver_id = actor1, receiver_id = recipient1) %>%
    summarise(groom_count = n(), .groups = "drop") %>%
    filter(!is.na(giver_id), !is.na(receiver_id), groom_count > 0)
  
  g_dir <- graph_from_data_frame(edges_g, directed = TRUE)
  E(g_dir)$weight <- edges_g$groom_count
  g_und <- as_undirected(
    g_dir,
    mode = "collapse",
    edge.attr.comb = list(weight = "sum")
  )
  
  eig_vec <- eigen_centrality(
    g_und,
    directed = FALSE,
    weights = E(g_und)$weight
  )$vector
  
  centrality_df <- data.frame(
    ID         = V(g_dir)$name,
    degree     = degree(g_dir, mode = "all"),
    out_degree = degree(g_dir, mode = "out"),
    in_degree  = degree(g_dir, mode = "in"),
    strength   = strength(g_dir, mode = "all", weights = E(g_dir)$weight),
    eigenvector = eig_vec[ match(V(g_dir)$name, names(eig_vec)) ]
  )
  
  ssb_counts <- dat_g %>%
    filter(action == "M") %>%
    transmute(ID = actor1) %>%
    bind_rows(dat_g %>% filter(action == "M") %>% transmute(ID = recipient1)) %>%
    filter(!is.na(ID)) %>%
    count(ID, name = "n_ssb_mounts")
  
  merged <- centrality_df %>%
    left_join(ssb_counts, by = "ID") %>%
    left_join(controls, by = c("ID" = "id")) %>%
    mutate(
      n_ssb_mounts = if_else(
        !is.na(observability) & observability > 0 & is.na(n_ssb_mounts),
        0L, as.integer(n_ssb_mounts)
      )
    ) %>%
    filter(complete.cases(degree, strength, eigenvector, age, davids_score, observability, n_ssb_mounts))
  
  pc <- prcomp(scale(merged[, c("degree","strength","eigenvector")]), center = TRUE, scale. = TRUE)
  pc1 <- pc$x[, 1]
  if (cor(pc1, merged$eigenvector, use = "complete.obs") < 0) pc1 <- -pc1
  merged$centrality_PC1 <- pc1
  
  merged$group <- g_label
  merged
}

df_1 <- build_group_df("1")
df_2 <- build_group_df("2")

pooled <- bind_rows(df_1, df_2) %>%
  group_by(group) %>%
  mutate(
    centrality_PC1_z = as.numeric(scale(centrality_PC1))
  ) %>%
  ungroup()

with(df_1, cor(centrality_PC1, eigenvector, use = "complete.obs"))
with(df_2, cor(centrality_PC1, eigenvector, use = "complete.obs"))

mod_pooled_nb <- glmmTMB(
  n_ssb_mounts ~ centrality_PC1_z + age + davids_score + observability + factor(group),
  family = nbinom2,
  data = pooled
)
summary(mod_pooled_nb)

mod_pooled_int <- glmmTMB(
  n_ssb_mounts ~ centrality_PC1_z * factor(group) + age + davids_score + observability,
  family = nbinom2,
  data = pooled
)

anova(mod_pooled_nb, mod_pooled_int)

vc <- vcov(mod_pooled_int)$cond
co <- summary(mod_pooled_int)$coefficients$cond

beta_1 <- co["centrality_PC1_z","Estimate"]
se_1   <- sqrt(vc["centrality_PC1_z","centrality_PC1_z"])

beta_diff <- co["centrality_PC1_z:factor(group)2","Estimate"]
se_diff   <- sqrt(vc["centrality_PC1_z:factor(group)2","centrality_PC1_z:factor(group)2"])

beta_2 <- beta_1 + beta_diff
se_2   <- sqrt(se_1^2 + se_diff^2 + 2*vc["centrality_PC1_z","centrality_PC1_z:factor(group)2"])

ci_1 <- beta_1 + c(-1,1)*1.96*se_1
ci_2 <- beta_2 + c(-1,1)*1.96*se_2

data.frame(group=c("1","2"),
           beta=c(beta_1,beta_2),
           lo=c(ci_1[1],ci_2[1]),
           hi=c(ci_1[2],ci_2[2]))



## DSB Count

raw_male   <- read.csv("raw_male_groom_mount_23_24_25.csv")   
raw_total  <- read.csv("raw_groom_mount_23_24_25.csv")         
controls   <- read_csv("control_variables_23_24_25.csv", show_col_types = FALSE) %>%
  select(id, age, davids_score, observability)

is_female_id <- function(x) grepl("FUN|\\(F\\)", x, ignore.case = TRUE)
is_male_id   <- function(x) !is.na(x) & !is_female_id(x)

build_group_df_dsb <- function(g_label) {
  dat_g_male  <- raw_male  %>% filter(group == g_label)     # Male-only for centrality
  dat_g_total <- raw_total %>% filter(group == g_label)     # All-sex for DSB counts
  
  edges_g <- dat_g_male %>%
    filter(action == "Gr") %>%
    group_by(giver_id = actor1, receiver_id = recipient1) %>%
    summarise(groom_count = n(), .groups = "drop") %>%
    filter(!is.na(giver_id), !is.na(receiver_id), groom_count > 0)
  
  g_dir <- graph_from_data_frame(edges_g, directed = TRUE)
  E(g_dir)$weight <- edges_g$groom_count
  g_und <- as_undirected(
    g_dir,
    mode = "collapse",
    edge.attr.comb = list(weight = "sum")
  )
  
  eig_vec <- eigen_centrality(
    g_und,
    directed = FALSE,
    weights = E(g_und)$weight
  )$vector
  
  centrality_df <- data.frame(
    ID          = V(g_dir)$name,
    degree      = degree(g_dir, mode = "all"),
    out_degree  = degree(g_dir, mode = "out"),
    in_degree   = degree(g_dir, mode = "in"),
    strength    = strength(g_dir, mode = "all", weights = E(g_dir)$weight),
    eigenvector = eig_vec[ match(V(g_dir)$name, names(eig_vec)) ]
  )
  
  dsb_counts <- dat_g_total %>%
    filter(action == "M", is_male_id(actor1), is_female_id(recipient1)) %>%
    transmute(ID = actor1) %>%
    count(ID, name = "n_dsb_mounts")
  
  merged_dsb <- centrality_df %>%
    left_join(dsb_counts, by = "ID") %>%
    left_join(controls, by = c("ID" = "id")) %>%
    mutate(
      n_dsb_mounts = if_else(
        !is.na(observability) & observability > 0 & is.na(n_dsb_mounts),
        0L, as.integer(n_dsb_mounts)
      )
    ) %>%
    filter(complete.cases(degree, strength, eigenvector, age, davids_score, observability, n_dsb_mounts))
  
  pc <- prcomp(scale(merged_dsb[, c("degree","strength","eigenvector")]), center = TRUE, scale. = TRUE)
  pc1 <- pc$x[, 1]
  if (cor(pc1, merged_dsb$eigenvector, use = "complete.obs") < 0) pc1 <- -pc1
  merged_dsb$centrality_PC1_dsb <- pc1
  
  merged_dsb$group <- g_label
  merged_dsb
}

df_1_dsb <- build_group_df_dsb("1")
df_2_dsb <- build_group_df_dsb("2")

pooled_dsb <- bind_rows(df_1_dsb, df_2_dsb) %>%
  group_by(group) %>%
  mutate(
    centrality_PC1_z_dsb = as.numeric(scale(centrality_PC1_dsb))
  ) %>%
  ungroup()

with(df_1_dsb, cor(centrality_PC1_dsb, eigenvector, use = "complete.obs"))
with(df_2_dsb, cor(centrality_PC1_dsb, eigenvector, use = "complete.obs"))

mod_nb_dsb <- glmmTMB(
  n_dsb_mounts ~ centrality_PC1_z_dsb + age + davids_score + observability + factor(group),
  family = nbinom2,
  data = pooled_dsb
)
summary(mod_nb_dsb)

mod_pooled_int_dsb <- glmmTMB(
  n_dsb_mounts ~ centrality_PC1_z_dsb * factor(group) + age + davids_score + observability,
  family = nbinom2,
  data = pooled_dsb
)

anova(mod_nb_dsb, mod_pooled_int_dsb)

vc_dsb <- vcov(mod_pooled_int_dsb)$cond
co_dsb <- summary(mod_pooled_int_dsb)$coefficients$cond

beta_1_dsb <- co_dsb["centrality_PC1_z_dsb","Estimate"]
se_1_dsb   <- sqrt(vc_dsb["centrality_PC1_z_dsb","centrality_PC1_z_dsb"])

beta_diff_dsb <- co_dsb["centrality_PC1_z_dsb:factor(group)2","Estimate"]
se_diff_dsb   <- sqrt(vc_dsb["centrality_PC1_z_dsb:factor(group)2","centrality_PC1_z_dsb:factor(group)2"])

beta_2_dsb <- beta_1_dsb + beta_diff_dsb
se_2_dsb   <- sqrt(se_1_dsb^2 + se_diff_dsb^2 + 2*vc_dsb["centrality_PC1_z_dsb","centrality_PC1_z_dsb:factor(group)2"])

# 95% CIs (Wald)
ci_1_dsb <- beta_1_dsb + c(-1,1)*1.96*se_1_dsb
ci_2_dsb <- beta_2_dsb + c(-1,1)*1.96*se_2_dsb

data.frame(group=c("1","2"),
           beta_dsb=c(beta_1_dsb, beta_2_dsb),
           lo_dsb=c(ci_1_dsb[1], ci_2_dsb[1]),
           hi_dsb=c(ci_1_dsb[2], ci_2_dsb[2]))



## Total mounts 

raw_male   <- read.csv("raw_male_groom_mount_23_24_25.csv")   
raw_total  <- read.csv("raw_groom_mount_23_24_25.csv")         
controls   <- read_csv("control_variables_23_24_25.csv", show_col_types = FALSE) %>%
  select(id, age, davids_score, observability)

build_group_df_total <- function(g_label) {
  dat_g_male  <- raw_male  %>% filter(group == g_label)
  dat_g_total <- raw_total %>% filter(group == g_label)
  
  edges_g <- dat_g_male %>%
    filter(action == "Gr") %>%
    group_by(giver_id = actor1, receiver_id = recipient1) %>%
    summarise(groom_count = n(), .groups = "drop") %>%
    filter(!is.na(giver_id), !is.na(receiver_id), groom_count > 0)
  
  g_dir <- graph_from_data_frame(edges_g, directed = TRUE)
  E(g_dir)$weight <- edges_g$groom_count
  g_und <- as_undirected(
    g_dir,
    mode = "collapse",
    edge.attr.comb = list(weight = "sum")
  )
  
  eig_vec <- eigen_centrality(
    g_und,
    directed = FALSE,
    weights = E(g_und)$weight
  )$vector
  
  centrality_df <- data.frame(
    ID          = V(g_dir)$name,
    degree      = degree(g_dir, mode = "all"),
    out_degree  = degree(g_dir, mode = "out"),
    in_degree   = degree(g_dir, mode = "in"),
    strength    = strength(g_dir, mode = "all", weights = E(g_dir)$weight),
    eigenvector = eig_vec[ match(V(g_dir)$name, names(eig_vec)) ]
  )
  
  total_counts <- dat_g_total %>%
    filter(action == "M") %>%
    transmute(ID = actor1) %>%
    bind_rows(dat_g_total %>% filter(action == "M") %>% transmute(ID = recipient1)) %>%
    filter(!is.na(ID)) %>%
    count(ID, name = "n_total_mounts")
  
  merged_total <- centrality_df %>%
    left_join(total_counts, by = "ID") %>%
    left_join(controls, by = c("ID" = "id")) %>%
    mutate(
      n_total_mounts = if_else(
        !is.na(observability) & observability > 0 & is.na(n_total_mounts),
        0L, as.integer(n_total_mounts)
      )
    ) %>%
    filter(complete.cases(degree, strength, eigenvector, age, davids_score, observability, n_total_mounts))
  
  pc <- prcomp(scale(merged_total[, c("degree","strength","eigenvector")]), center = TRUE, scale. = TRUE)
  pc1 <- pc$x[, 1]
  if (cor(pc1, merged_total$eigenvector, use = "complete.obs") < 0) pc1 <- -pc1
  merged_total$centrality_PC1_total <- pc1
  
  merged_total$group <- g_label
  merged_total
}

df_1_total <- build_group_df_total("1")
df_2_total <- build_group_df_total("2")

pooled_total <- bind_rows(df_1_total, df_2_total) %>%
  group_by(group) %>%
  mutate(
    centrality_PC1_z_total = as.numeric(scale(centrality_PC1_total))
  ) %>%
  ungroup()

with(df_1_total, cor(centrality_PC1_total, eigenvector, use = "complete.obs"))
with(df_2_total, cor(centrality_PC1_total, eigenvector, use = "complete.obs"))

pooled_total$group <- factor(pooled_total$group)

mod_nb_total <- glmmTMB(
  n_total_mounts ~ centrality_PC1_z_total + age + davids_score + observability + group,
  family = nbinom2,
  data = pooled_total
)
summary(mod_nb_total)

mod_pooled_int_total <- glmmTMB(
  n_total_mounts ~ centrality_PC1_z_total * group + age + davids_score + observability,
  family = nbinom2,
  data = pooled_total
)

anova(mod_nb_total, mod_pooled_int_total)

vc_total <- vcov(mod_pooled_int_total)$cond
co_total <- summary(mod_pooled_int_total)$coefficients$cond

beta_1_total <- co_total["centrality_PC1_z_total","Estimate"]
se_1_total   <- sqrt(vc_total["centrality_PC1_z_total","centrality_PC1_z_total"])

beta_diff_total <- co_total["centrality_PC1_z_total:group2","Estimate"]
se_diff_total   <- sqrt(vc_total["centrality_PC1_z_total:group2","centrality_PC1_z_total:group2"])

beta_2_total <- beta_1_total + beta_diff_total
se_2_total   <- sqrt(se_1_total^2 + se_diff_total^2 + 2*vc_total["centrality_PC1_z_total","centrality_PC1_z_total:group2"])

ci_1_total <- beta_1_total + c(-1,1)*1.96*se_1_total
ci_2_total <- beta_2_total + c(-1,1)*1.96*se_2_total

data.frame(group=c("1","2"),
           beta_total=c(beta_1_total, beta_2_total),
           lo_total=c(ci_1_total[1], ci_2_total[1]),
           hi_total=c(ci_1_total[2], ci_2_total[2]))





### Robustness Check - Univariate Models for Centrality Metrics ###

## SSB

pooled_cnt <- bind_rows(df_1, df_2) %>%
  transmute(
    ID,
    group = factor(group, levels = c("1","2")),   # "1" as reference
    degree, strength, eigenvector,
    age, davids_score, observability,
    n_ssb_mounts = as.integer(n_ssb_mounts)
  ) %>%
  filter(
    !is.na(n_ssb_mounts),
    is.finite(degree), is.finite(strength), is.finite(eigenvector),
    is.finite(age), is.finite(davids_score), is.finite(observability)
  )

per_group_slopes_tmb <- function(mod, term, other_group = "2") {
  co <- summary(mod)$coefficients$cond
  vc <- vcov(mod)$cond
  
  b_1  <- co[term, "Estimate"]
  se_1 <- sqrt(vc[term, term])
  ci_1 <- b_1 + c(-1, 1) * 1.96 * se_1
  
  int_name <- paste0(term, ":group", other_group)
  if (!int_name %in% rownames(co)) int_name <- paste0("group", other_group, ":", term)
  
  b_diff <- co[int_name, "Estimate"]
  v_diff <- vc[int_name, int_name]
  covar  <- vc[term, int_name]
  
  b_2  <- b_1 + b_diff
  se_2 <- sqrt(se_1^2 + v_diff + 2 * covar)
  ci_2 <- b_2 + c(-1, 1) * 1.96 * se_2
  
  data.frame(
    group  = c("1", other_group),
    beta   = c(b_1, b_2),
    lo     = c(ci_1[1], ci_2[1]),
    hi     = c(ci_1[2], ci_2[2]),
    IRR    = exp(c(b_1, b_2)),
    IRR_lo = exp(c(ci_1[1], ci_2[1])),
    IRR_hi = exp(c(ci_1[2], ci_2[2]))
  )
}


# Degree
mod_ssb_deg <- glmmTMB(
  n_ssb_mounts ~ degree + age + davids_score + observability + group,
  family = nbinom2,
  data = pooled_cnt
)
summary(mod_ssb_deg)

mod_ssb_deg_int <- glmmTMB(
  n_ssb_mounts ~ degree * group + age + davids_score + observability,
  family = nbinom2,
  data = pooled_cnt
)
anova(mod_ssb_deg, mod_ssb_deg_int)
slopes_deg <- per_group_slopes_tmb(mod_ssb_deg_int, term = "degree")
slopes_deg


# Strength
mod_ssb_str <- glmmTMB(
  n_ssb_mounts ~ strength + age + davids_score + observability + group,
  family = nbinom2,
  data = pooled_cnt
)
summary(mod_ssb_str)

mod_ssb_str_int <- glmmTMB(
  n_ssb_mounts ~ strength * group + age + davids_score + observability,
  family = nbinom2,
  data = pooled_cnt
)
anova(mod_ssb_str, mod_ssb_str_int)
slopes_str <- per_group_slopes_tmb(mod_ssb_str_int, term = "strength")
slopes_str


# Eigenvector Centrality
mod_ssb_eig <- glmmTMB(
  n_ssb_mounts ~ eigenvector + age + davids_score + observability + group,
  family = nbinom2,
  data = pooled_cnt
)
summary(mod_ssb_eig)

mod_ssb_eig_int <- glmmTMB(
  n_ssb_mounts ~ eigenvector * group + age + davids_score + observability,
  family = nbinom2,
  data = pooled_cnt
)
anova(mod_ssb_eig, mod_ssb_eig_int)
slopes_eig <- per_group_slopes_tmb(mod_ssb_eig_int, term = "eigenvector")
slopes_eig



## DSB

pooled_cnt_dsb <- bind_rows(df_1_dsb, df_2_dsb) %>%
  transmute(
    ID,
    group = factor(group, levels = c("1","2")),   # "1" as reference
    degree, strength, eigenvector,
    age, davids_score, observability,
    n_dsb_mounts = as.integer(n_dsb_mounts)
  ) %>%
  filter(
    !is.na(n_dsb_mounts),
    is.finite(degree), is.finite(strength), is.finite(eigenvector),
    is.finite(age), is.finite(davids_score), is.finite(observability)
  )

per_group_slopes_tmb_dsb <- function(mod, term, other_group = "2") {
  co <- summary(mod)$coefficients$cond
  vc <- vcov(mod)$cond
  
  b_1  <- co[term, "Estimate"]
  se_1 <- sqrt(vc[term, term])
  ci_1 <- b_1 + c(-1, 1) * 1.96 * se_1
  
  int_name <- paste0(term, ":group", other_group)
  if (!int_name %in% rownames(co)) int_name <- paste0("group", other_group, ":", term)
  
  b_diff <- co[int_name, "Estimate"]
  v_diff <- vc[int_name, int_name]
  covar  <- vc[term, int_name]
  
  b_2  <- b_1 + b_diff
  se_2 <- sqrt(se_1^2 + v_diff + 2 * covar)
  ci_2 <- b_2 + c(-1, 1) * 1.96 * se_2
  
  data.frame(
    group  = c("1", other_group),
    beta   = c(b_1, b_2),
    lo     = c(ci_1[1], ci_2[1]),
    hi     = c(ci_1[2], ci_2[2]),
    IRR    = exp(c(b_1, b_2)),
    IRR_lo = exp(c(ci_1[1], ci_2[1])),
    IRR_hi = exp(c(ci_1[2], ci_2[2]))
  )
}


# Degree
mod_dsb_deg <- glmmTMB(
  n_dsb_mounts ~ degree + age + davids_score + observability + group,
  family = nbinom2,
  data = pooled_cnt_dsb
)
summary(mod_dsb_deg)

mod_dsb_deg_int <- glmmTMB(
  n_dsb_mounts ~ degree * group + age + davids_score + observability,
  family = nbinom2,
  data = pooled_cnt_dsb
)
anova(mod_dsb_deg, mod_dsb_deg_int)
slopes_deg_dsb <- per_group_slopes_tmb_dsb(mod_dsb_deg_int, term = "degree")
slopes_deg_dsb


# Strength
mod_dsb_str <- glmmTMB(
  n_dsb_mounts ~ strength + age + davids_score + observability + group,
  family = nbinom2,
  data = pooled_cnt_dsb
)
summary(mod_dsb_str)

mod_dsb_str_int <- glmmTMB(
  n_dsb_mounts ~ strength * group + age + davids_score + observability,
  family = nbinom2,
  data = pooled_cnt_dsb
)
anova(mod_dsb_str, mod_dsb_str_int)
slopes_str_dsb <- per_group_slopes_tmb_dsb(mod_dsb_str_int, term = "strength")
slopes_str_dsb


# Eigenvector Centrality
mod_dsb_eig <- glmmTMB(
  n_dsb_mounts ~ eigenvector + age + davids_score + observability + group,
  family = nbinom2,
  data = pooled_cnt_dsb
)
summary(mod_dsb_eig)

mod_dsb_eig_int <- glmmTMB(
  n_dsb_mounts ~ eigenvector * group + age + davids_score + observability,
  family = nbinom2,
  data = pooled_cnt_dsb
)
anova(mod_dsb_eig, mod_dsb_eig_int)
slopes_eig_dsb <- per_group_slopes_tmb_dsb(mod_dsb_eig_int, term = "eigenvector")
slopes_eig_dsb



## Total Mounts

pooled_cnt_total <- bind_rows(df_1_total, df_2_total) %>%
  transmute(
    ID,
    group = factor(group, levels = c("1","2")),   # "1" as reference
    degree, strength, eigenvector,
    age, davids_score, observability,
    n_total_mounts = as.integer(n_total_mounts)
  ) %>%
  filter(
    !is.na(n_total_mounts),
    is.finite(degree), is.finite(strength), is.finite(eigenvector),
    is.finite(age), is.finite(davids_score), is.finite(observability)
  )

per_group_slopes_tmb_total <- function(mod, term, other_group = "2") {
  co <- summary(mod)$coefficients$cond
  vc <- vcov(mod)$cond
  
  b_1  <- co[term, "Estimate"]
  se_1 <- sqrt(vc[term, term])
  ci_1 <- b_1 + c(-1, 1) * 1.96 * se_1
  
  int_name <- paste0(term, ":group", other_group)
  if (!int_name %in% rownames(co)) int_name <- paste0("group", other_group, ":", term)
  
  b_diff <- co[int_name, "Estimate"]
  v_diff <- vc[int_name, int_name]
  covar  <- vc[term, int_name]
  
  b_2  <- b_1 + b_diff
  se_2 <- sqrt(se_1^2 + v_diff + 2 * covar)
  ci_2 <- b_2 + c(-1, 1) * 1.96 * se_2
  
  data.frame(
    group  = c("1", other_group),
    beta   = c(b_1, b_2),
    lo     = c(ci_1[1], ci_2[1]),
    hi     = c(ci_1[2], ci_2[2]),
    IRR    = exp(c(b_1, b_2)),
    IRR_lo = exp(c(ci_1[1], ci_2[1])),
    IRR_hi = exp(c(ci_1[2], ci_2[2]))
  )
}


# Degree
mod_total_deg <- glmmTMB(
  n_total_mounts ~ degree + age + davids_score + observability + group,
  family = nbinom2,
  data = pooled_cnt_total
)
summary(mod_total_deg)

mod_total_deg_int <- glmmTMB(
  n_total_mounts ~ degree * group + age + davids_score + observability,
  family = nbinom2,
  data = pooled_cnt_total
)
anova(mod_total_deg, mod_total_deg_int)
slopes_deg_total <- per_group_slopes_tmb_total(mod_total_deg_int, term = "degree")
slopes_deg_total


# Strength
mod_total_str <- glmmTMB(
  n_total_mounts ~ strength + age + davids_score + observability + group,
  family = nbinom2,
  data = pooled_cnt_total
)
summary(mod_total_str)

mod_total_str_int <- glmmTMB(
  n_total_mounts ~ strength * group + age + davids_score + observability,
  family = nbinom2,
  data = pooled_cnt_total
)
anova(mod_total_str, mod_total_str_int)
slopes_str_total <- per_group_slopes_tmb_total(mod_total_str_int, term = "strength")
slopes_str_total


# Eigenvector Centrality
mod_total_eig <- glmmTMB(
  n_total_mounts ~ eigenvector + age + davids_score + observability + group,
  family = nbinom2,
  data = pooled_cnt_total
)
summary(mod_total_eig)

mod_total_eig_int <- glmmTMB(
  n_total_mounts ~ eigenvector * group + age + davids_score + observability,
  family = nbinom2,
  data = pooled_cnt_total
)
anova(mod_total_eig, mod_total_eig_int)
slopes_eig_total <- per_group_slopes_tmb_total(mod_total_eig_int, term = "eigenvector")
slopes_eig_total





### Plot Social Network Maps ###

raw_male <- read_csv("raw_male_groom_mount_23_24_25.csv", show_col_types = FALSE)

make_edges <- function(dat, grp) {
  dat %>%
    filter(group == grp, action == "Gr") %>%
    transmute(giver_id = actor1, receiver_id = recipient1) %>%
    filter(!is.na(giver_id), !is.na(receiver_id), giver_id != "", receiver_id != "") %>%
    group_by(giver_id, receiver_id) %>%
    summarise(groom_count = n(), .groups = "drop")
}

write_csv(make_edges(raw_male, "1"), "grooming_edge_list_1.csv")
write_csv(make_edges(raw_male, "2"), "grooming_edge_list_2.csv")


## SSB 

plot_group_map_count <- function(edges_file, df_group, title_text) {
  edges <- read_csv(edges_file, show_col_types = FALSE)
  
  if ("groom_count" %in% names(edges) && !"weight" %in% names(edges)) {
    edges <- edges %>% rename(weight = groom_count)
  } else if (!"weight" %in% names(edges)) {
    edges <- edges %>% group_by(across(1:2)) %>% summarise(weight = n(), .groups = "drop")
  }
  
  g <- graph_from_data_frame(edges, directed = TRUE)
  
  col_or <- function(df, nm) if (nm %in% names(df)) df[[nm]] else rep(NA_real_, nrow(df))
  
  ssb_count_vec <- dplyr::coalesce(
    suppressWarnings(as.numeric(col_or(df_group, "n_ssb_mounts"))),
    suppressWarnings(as.numeric(col_or(df_group, "ssb_count")))
  )
  names(ssb_count_vec) <- df_group$ID
  V(g)$ssb_count <- ssb_count_vec[ match(V(g)$name, df_group$ID) ]
  
  tg <- as_tbl_graph(g)
  set.seed(123) 
  
  ggraph(tg, layout = "kk") +
    geom_edge_link(
      aes(edge_width = weight),
      arrow       = arrow(length = unit(2, 'mm')),
      end_cap     = circle(3, 'mm'),
      edge_alpha  = 0.35,
      edge_colour = "grey20",
      show.legend = TRUE
    ) +
    scale_edge_width(range = c(0.15, 1.6), trans = "sqrt", name = "Grooming amount") +
    geom_node_point(aes(color = ssb_count), size = 8, show.legend = TRUE) +
    scale_color_gradientn(
      colours = RColorBrewer::brewer.pal(9, "Blues")[2:9],
      na.value = "grey85",
      name = "SSB count"
    ) +
    theme_graph(base_family = "Arial") +
    theme(
      legend.position = "right",
      plot.title = element_text(size = 22, face = "bold", hjust = 0),
      plot.subtitle = element_text(size = 18, hjust = 0)
    ) +
    labs(
      title = title_text,
      subtitle = "Node colour = SSB count; edge width = grooming amount"
    )
}

p_1 <- plot_group_map_count("grooming_edge_list_1.csv", df_1, "Grooming Network (Group 1)")
p_2 <- plot_group_map_count("grooming_edge_list_2.csv", df_2, "Grooming Network (Group 2)")

p_1
p_2



## DSB

plot_group_map_count_dsb <- function(edges_file, df_group, title_text) {
  edges <- read_csv(edges_file, show_col_types = FALSE)
  
  if ("groom_count" %in% names(edges) && !"weight" %in% names(edges)) {
    edges <- edges %>% rename(weight = groom_count)
  } else if (!"weight" %in% names(edges)) {
    edges <- edges %>%
      group_by(across(1:2)) %>%
      summarise(weight = n(), .groups = "drop")
  }
  
  g <- graph_from_data_frame(edges, directed = TRUE)
  
  col_or <- function(df, nm) if (nm %in% names(df)) df[[nm]] else rep(NA_real_, nrow(df))
  
  dsb_count_vec <- dplyr::coalesce(
    suppressWarnings(as.numeric(col_or(df_group, "n_dsb_mounts"))),
    suppressWarnings(as.numeric(col_or(df_group, "dsb_count")))
  )
  names(dsb_count_vec) <- df_group$ID
  V(g)$dsb_count <- dsb_count_vec[ match(V(g)$name, df_group$ID) ]
  
  tg <- as_tbl_graph(g)
  set.seed(123)  
  
  ggraph(tg, layout = "kk") +
    geom_edge_link(
      aes(edge_width = weight),
      arrow       = arrow(length = unit(2, 'mm')),
      end_cap     = circle(3, 'mm'),
      edge_alpha  = 0.35,
      edge_colour = "grey20",
      show.legend = TRUE
    ) +
    scale_edge_width(range = c(0.15, 1.6), trans = "sqrt", name = "Grooming amount") +
    geom_node_point(aes(color = dsb_count), size = 8, show.legend = TRUE) +
    scale_color_gradientn(
      colours = RColorBrewer::brewer.pal(9, "Blues")[2:9],
      na.value = "grey85",
      name = "DSB count"
    ) +
    theme_graph(base_family = "Arial") +
    theme(
      legend.position = "right",
      plot.title = element_text(size = 22, face = "bold", hjust = 0),
      plot.subtitle = element_text(size = 18, hjust = 0)
    ) +
    labs(
      title = title_text,
      subtitle = "Node colour = DSB count; edge width = grooming amount"
    )
}

p_1_dsb <- plot_group_map_count_dsb("grooming_edge_list_1.csv", df_1_dsb, "Grooming Network (Group 1) — DSB")
p_2_dsb <- plot_group_map_count_dsb("grooming_edge_list_2.csv", df_2_dsb, "Grooming Network (Group 2) — DSB")

p_1_dsb
p_2_dsb



## Total Mounts

plot_group_map_count_total <- function(edges_file, df_group, title_text) {
  edges <- read_csv(edges_file, show_col_types = FALSE)
  
  if ("groom_count" %in% names(edges) && !"weight" %in% names(edges)) {
    edges <- edges %>% rename(weight = groom_count)
  } else if (!"weight" %in% names(edges)) {
    edges <- edges %>%
      group_by(across(1:2)) %>%
      summarise(weight = n(), .groups = "drop")
  }
  
  g <- graph_from_data_frame(edges, directed = TRUE)
  
  col_or <- function(df, nm) if (nm %in% names(df)) df[[nm]] else rep(NA_real_, nrow(df))
  
  total_count_vec <- dplyr::coalesce(
    suppressWarnings(as.numeric(col_or(df_group, "n_total_mounts"))),
    suppressWarnings(as.numeric(col_or(df_group, "total_count")))
  )
  names(total_count_vec) <- df_group$ID
  V(g)$total_count <- total_count_vec[ match(V(g)$name, df_group$ID) ]
  
  tg <- as_tbl_graph(g)
  set.seed(123)  
  
  ggraph(tg, layout = "kk") +
    geom_edge_link(
      aes(edge_width = weight),
      arrow       = arrow(length = unit(2, 'mm')),
      end_cap     = circle(3, 'mm'),
      edge_alpha  = 0.35,
      edge_colour = "grey20",
      show.legend = TRUE
    ) +
    scale_edge_width(range = c(0.15, 1.6), trans = "sqrt", name = "Grooming amount") +
    geom_node_point(aes(color = total_count), size = 8, show.legend = TRUE) +
    scale_color_gradientn(
      colours = RColorBrewer::brewer.pal(9, "Blues")[2:9],
      na.value = "grey85",
      name = "Total mounts"
    ) +
    theme_graph(base_family = "Arial") +
    theme(
      legend.position = "right",
      plot.title = element_text(size = 22, face = "bold", hjust = 0),
      plot.subtitle = element_text(size = 18, hjust = 0)
    ) +
    labs(
      title = title_text,
      subtitle = "Node colour = total mount count; edge width = grooming amount"
    )
}

p_1_total <- plot_group_map_count_total("grooming_edge_list_1.csv", df_1_total, "Grooming Network (Group 1) — Total mounts")
p_2_total <- plot_group_map_count_total("grooming_edge_list_2.csv", df_2_total, "Grooming Network (Group 2) — Total mounts")

p_1_total
p_2_total





### Potential Social Benefits of SSB - Rank Stability ###

## Data Wrangling

control <- read.csv("control_variables_23_24_25.csv", stringsAsFactors = FALSE)
aggr    <- read.csv("raw_aggression_mount_23_24_25.csv", stringsAsFactors = FALSE)  
wl      <- read.csv("winner_loser_interactions_23_24_25.csv", stringsAsFactors = FALSE)

is_disallowed <- function(x) {
  bad <- c("FUN","MUN","SAMUN","JVUN","JVMUN","INFANT")
  !is.na(x) & (x %in% bad | grepl("\\(F\\)", x))
}
is_male_id   <- function(x) !is.na(x) & !is_disallowed(x) & grepl("^[A-Za-z0-9]+$", x)
is_female_id <- function(x) !is.na(x) & (x == "FUN" | grepl("\\(F\\)$", x))

to_month_mixed <- function(v) {
  mdy_ <- suppressWarnings(mdy(v)); dmy_ <- suppressWarnings(dmy(v))
  out <- as.Date(NA)[seq_along(v)]
  for (i in seq_along(v)) {
    m_ok <- !is.na(mdy_[i]); d_ok <- !is.na(dmy_[i])
    m_in <- m_ok && month(mdy_[i]) %in% 1:5
    d_in <- d_ok && month(dmy_[i]) %in% 1:5
    out[i] <- if (m_ok && !d_ok) mdy_[i]
    else if (d_ok && !m_ok) dmy_[i]
    else if (m_in && !d_in) mdy_[i]
    else if (d_in && !m_in) dmy_[i]
    else if (m_in && d_in)  mdy_[i]
    else if (m_ok)          mdy_[i]
    else if (d_ok)          dmy_[i]
    else                    as.Date(NA)
  }
  floor_date(out, "month")
}

expand_pairs <- function(df) {
  df %>%
    mutate(row_id = dplyr::row_number()) %>%
    pivot_longer(c(actor1, actor2, actor3), names_to = "actor_slot", values_to = "actor") %>%
    pivot_longer(c(recipient1, recipient2, recipient3), names_to = "recip_slot", values_to = "recipient") %>%
    filter(!is.na(actor), !is.na(recipient), actor != recipient)
}

aggr <- aggr %>% mutate(month = to_month_mixed(date)) %>%
  filter(!is.na(month), month(month) %in% 1:5)
wl   <- wl   %>% mutate(month = to_month_mixed(date)) %>%
  filter(!is.na(month), month(month) %in% 1:5)


# Monthly SSB
mounts <- aggr %>% filter(action == "M") %>%
  select(month, actor1, actor2, actor3, recipient1, recipient2, recipient3)

mount_pairs <- expand_pairs(mounts) %>%
  mutate(is_ssb = is_male_id(actor) & is_male_id(recipient))

mount_long_ssb <- bind_rows(
  mount_pairs %>% transmute(month, id = actor,     is_ssb),
  mount_pairs %>% transmute(month, id = recipient, is_ssb)
) %>% filter(is_male_id(id))

monthly_ssb <- mount_long_ssb %>%
  group_by(id, month) %>%
  summarise(ssb_count = sum(is_ssb), .groups = "drop")

write.csv(monthly_ssb, "monthly_ssb_count_only.csv", row.names = FALSE)


# Monthly DSB
mount_long_dsb <- mount_pairs %>%
  mutate(is_dsb = is_male_id(actor) & is_female_id(recipient)) %>%
  transmute(month, id = actor, is_dsb) %>%
  filter(is_male_id(id))

monthly_dsb <- mount_long_dsb %>%
  group_by(id, month) %>%
  summarise(dsb_count = sum(is_dsb), .groups = "drop")

write.csv(monthly_dsb, "monthly_dsb_count_only.csv", row.names = FALSE)


# Monthly Total Mounts
mount_long_total <- bind_rows(
  mount_pairs %>% transmute(month, id = actor),
  mount_pairs %>% transmute(month, id = recipient)
) %>% filter(is_male_id(id))

monthly_total_mounts <- mount_long_total %>%
  group_by(id, month) %>%
  summarise(total_mounts = n(), .groups = "drop")

write.csv(monthly_total_mounts, "monthly_total_mounts_from_aggression.csv", row.names = FALSE)


# Monthly Rank
wl_core <- wl %>%
  filter(action %in% c("Ag","Su")) %>%
  select(month, action, actor1, actor2, actor3, recipient1, recipient2, recipient3)

pairs_wl <- expand_pairs(wl_core) %>%
  mutate(
    winner = ifelse(action == "Ag", actor, recipient),
    loser  = ifelse(action == "Ag", recipient, actor)
  ) %>%
  filter(is_male_id(winner) & is_male_id(loser)) %>%
  select(month, winner, loser)

compute_ds_month <- function(df_month) {
  if (nrow(df_month) == 0) return(data.frame(id = character(0), DS = numeric(0)))
  ids <- sort(unique(c(df_month$winner, df_month$loser)))
  n <- length(ids)
  if (n < 2) return(data.frame(id = ids, DS = 0))
  W <- matrix(0, n, n, dimnames = list(ids, ids))
  for (k in seq_len(nrow(df_month))) {
    W[df_month$winner[k], df_month$loser[k]] <- W[df_month$winner[k], df_month$loser[k]] + 1
  }
  P <- matrix(NA_real_, n, n, dimnames = list(ids, ids))
  for (i in ids) for (j in ids) {
    if (i == j) { P[i,j] <- NA_real_; next }
    denom <- W[i,j] + W[j,i]
    P[i,j] <- if (denom > 0) W[i,j] / denom else NA_real_
  }
  w  <- rowSums(P, na.rm = TRUE)
  l  <- colSums(P, na.rm = TRUE)
  w2 <- setNames(numeric(n), ids)
  l2 <- setNames(numeric(n), ids)
  for (i in ids) { w2[i] <- sum(w * P[i, ], na.rm = TRUE); l2[i] <- sum(l * P[, i], na.rm = TRUE) }
  DS <- w + w2 - l - l2
  data.frame(id = ids, DS = as.numeric(DS), stringsAsFactors = FALSE)
}

monthly_ds <- pairs_wl %>% group_by(month) %>% group_modify(~ compute_ds_month(.x)) %>% ungroup()
monthly_rank <- monthly_ds %>%
  group_by(month) %>% arrange(desc(DS), .by_group = TRUE) %>% mutate(rank = dense_rank(desc(DS))) %>% ungroup()

write.csv(monthly_rank, "monthly_rank.csv", row.names = FALSE)



## SSB

monthly_ssb  <- read.csv("monthly_ssb_count_only.csv", stringsAsFactors = FALSE)
monthly_rank <- read.csv("monthly_rank.csv",               stringsAsFactors = FALSE)
control      <- read.csv("control_variables_23_24_25.csv", stringsAsFactors = FALSE)

monthly_ssb$id   <- as.character(monthly_ssb$id)
monthly_rank$id  <- as.character(monthly_rank$id)
control$id       <- as.character(control$id)
if (!inherits(monthly_ssb$month,  "Date")) monthly_ssb$month  <- as.Date(monthly_ssb$month)
if (!inherits(monthly_rank$month, "Date")) monthly_rank$month <- as.Date(monthly_rank$month)

stab_monthly_ssb <- monthly_rank %>%
  left_join(monthly_ssb %>% select(id, month, ssb_count), by = c("id","month")) %>%
  mutate(ssb_count = dplyr::coalesce(as.integer(ssb_count), 0L)) %>%
  arrange(id, month)

stab_var_ssb <- stab_monthly_ssb %>%
  group_by(id) %>%
  summarise(
    months_obs     = sum(!is.na(rank)),
    rank_var       = var(rank, na.rm = TRUE),
    ssb_count_mean = mean(ssb_count, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  left_join(control %>% select(id, age, observability), by = "id") %>%
  filter(months_obs >= 2) %>%
  mutate(
    age_z           = as.numeric(scale(age)),
    observability_z = as.numeric(scale(observability))
  )

write.csv(stab_var_ssb, "rank_stability_var_ssb_count.csv", row.names = FALSE)

m_rank_var_ssb_count <- lm(
  log1p(rank_var) ~ ssb_count_mean + age_z + observability_z,
  data = stab_var_ssb
)
summary(m_rank_var_ssb_count)



## DSB

monthly_dsb  <- read.csv("monthly_dsb_count_only.csv", stringsAsFactors = FALSE)
monthly_rank <- read.csv("monthly_rank.csv",            stringsAsFactors = FALSE)
control      <- read.csv("control_variables_23_24_25.csv", stringsAsFactors = FALSE)

monthly_dsb$id   <- as.character(monthly_dsb$id)
monthly_rank$id  <- as.character(monthly_rank$id)
control$id       <- as.character(control$id)
if (!inherits(monthly_dsb$month,  "Date")) monthly_dsb$month  <- as.Date(monthly_dsb$month)
if (!inherits(monthly_rank$month, "Date")) monthly_rank$month <- as.Date(monthly_rank$month)

stab_monthly_dsb <- monthly_rank %>%
  left_join(monthly_dsb %>% select(id, month, dsb_count), by = c("id","month")) %>%
  mutate(dsb_count = dplyr::coalesce(as.integer(dsb_count), 0L)) %>%
  arrange(id, month)

stab_var_dsb <- stab_monthly_dsb %>%
  group_by(id) %>%
  summarise(
    months_obs    = sum(!is.na(rank)),
    rank_var      = var(rank, na.rm = TRUE),
    dsb_count_mean= mean(dsb_count, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  left_join(control %>% select(id, age, observability), by = "id") %>%
  filter(months_obs >= 2) %>%
  mutate(
    age_z           = as.numeric(scale(age)),
    observability_z = as.numeric(scale(observability))
  )

write.csv(stab_var_dsb, "rank_stability_var_dsb_count.csv", row.names = FALSE)

m_rank_var_dsb_count <- lm(
  log1p(rank_var) ~ dsb_count_mean + age_z + observability_z,
  data = stab_var_dsb
)
summary(m_rank_var_dsb_count)



## Total Mounts

monthly_total <- read.csv("monthly_total_mounts_from_aggression.csv", stringsAsFactors = FALSE)
monthly_rank  <- read.csv("monthly_rank.csv",                          stringsAsFactors = FALSE)
control       <- read.csv("control_variables_23_24_25.csv",            stringsAsFactors = FALSE)

monthly_total$id <- as.character(monthly_total$id)
monthly_rank$id  <- as.character(monthly_rank$id)
control$id       <- as.character(control$id)
if (!inherits(monthly_total$month, "Date")) monthly_total$month <- as.Date(monthly_total$month)
if (!inherits(monthly_rank$month,  "Date")) monthly_rank$month  <- as.Date(monthly_rank$month)

stab_monthly_total <- monthly_rank %>%
  left_join(monthly_total %>% select(id, month, total_mounts), by = c("id","month")) %>%
  mutate(total_mounts = dplyr::coalesce(as.integer(total_mounts), 0L)) %>%
  arrange(id, month)

stab_var_total <- stab_monthly_total %>%
  group_by(id) %>%
  summarise(
    months_obs        = sum(!is.na(rank)),
    rank_var          = var(rank, na.rm = TRUE),
    total_mounts_mean = mean(total_mounts, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  left_join(control %>% select(id, age, observability), by = "id") %>%
  filter(months_obs >= 2) %>%
  mutate(
    age_z           = as.numeric(scale(age)),
    observability_z = as.numeric(scale(observability))
  )

write.csv(stab_var_total, "rank_stability_var_total_mounts.csv", row.names = FALSE)

m_rank_var_total <- lm(
  log1p(rank_var) ~ total_mounts_mean + age_z + observability_z,
  data = stab_var_total
)
summary(m_rank_var_total)





### Potential Social Benefits of SSB - Rank Gain ###

## SSB

monthly_ssb  <- read.csv("monthly_ssb_count_only.csv", stringsAsFactors = FALSE)
monthly_rank <- read.csv("monthly_rank.csv",            stringsAsFactors = FALSE)
control      <- read.csv("control_variables_23_24_25.csv", stringsAsFactors = FALSE)

control <- control %>% mutate(id = as.character(id))
dat_rank_gain <- monthly_ssb %>%
  inner_join(monthly_rank, by = c("id","month")) %>%
  left_join(control, by = "id") %>%
  arrange(id, month) %>%
  group_by(id) %>%
  mutate(rank_lag = dplyr::lag(rank),
         gain     = -(rank - rank_lag)) %>%
  ungroup() %>%
  mutate(rank_lag_z      = as.numeric(scale(rank_lag)),
         age_z           = as.numeric(scale(age)),
         observability_z = as.numeric(scale(observability)))
write.csv(dat_rank_gain, "dat_rank_gain_ssb_count_only.csv", row.names = FALSE)

m_rank_gain_count <- lmer(
  gain ~ ssb_count + rank_lag_z + age_z + observability_z + (1 | id),
  data = dat_rank_gain %>%
    filter(!is.na(gain), !is.na(ssb_count), !is.na(rank_lag_z), !is.na(age_z), !is.na(observability_z))
)
summary(m_rank_gain_count)



## DSB

monthly_dsb  <- read.csv("monthly_dsb_count_only.csv", stringsAsFactors = FALSE)
monthly_rank <- read.csv("monthly_rank.csv",            stringsAsFactors = FALSE)
control      <- read.csv("control_variables_23_24_25.csv", stringsAsFactors = FALSE)

control <- control %>% mutate(id = as.character(id))
dat_rank_gain <- monthly_dsb %>%
  inner_join(monthly_rank, by = c("id","month")) %>%
  left_join(control, by = "id") %>%
  arrange(id, month) %>%
  group_by(id) %>%
  mutate(rank_lag = dplyr::lag(rank),
         gain     = -(rank - rank_lag)) %>%
  ungroup() %>%
  mutate(rank_lag_z      = as.numeric(scale(rank_lag)),
         age_z           = as.numeric(scale(age)),
         observability_z = as.numeric(scale(observability)))
write.csv(dat_rank_gain, "dat_rank_gain_dsb_count_only.csv", row.names = FALSE)

m_rank_gain_count_dsb <- lmer(
  gain ~ dsb_count + rank_lag_z + age_z + observability_z + (1 | id),
  data = dat_rank_gain %>%
    filter(!is.na(gain), !is.na(dsb_count), !is.na(rank_lag_z), !is.na(age_z), !is.na(observability_z))
)
summary(m_rank_gain_count_dsb)



## Total Mounts

monthly_total <- read.csv("monthly_total_mounts_from_aggression.csv", stringsAsFactors = FALSE)
monthly_rank  <- read.csv("monthly_rank.csv",                          stringsAsFactors = FALSE)
control       <- read.csv("control_variables_23_24_25.csv",            stringsAsFactors = FALSE)

control <- control %>% mutate(id = as.character(id))
dat_rank_gain <- monthly_total %>%
  inner_join(monthly_rank, by = c("id","month")) %>%
  left_join(control, by = "id") %>%
  arrange(id, month) %>%
  group_by(id) %>%
  mutate(
    rank_lag = dplyr::lag(rank),
    gain     = -(rank - rank_lag)      
  ) %>%
  ungroup() %>%
  mutate(
    rank_lag_z      = as.numeric(scale(rank_lag)),
    age_z           = as.numeric(scale(age)),
    observability_z = as.numeric(scale(observability))
  )
write.csv(dat_rank_gain, "dat_rank_gain_total_mounts.csv", row.names = FALSE)

m_rank_gain_total <- lmer(
  gain ~ total_mounts + rank_lag_z + age_z + observability_z + (1 | id),
  data = dat_rank_gain %>%
    filter(!is.na(gain),
           !is.na(total_mounts),
           !is.na(rank_lag_z),
           !is.na(age_z),
           !is.na(observability_z))
)
summary(m_rank_gain_total)





### Potential Social Benefits of SSB - Higher Ranking Partners (Coalitions and Grooming) ###

## Data Wrangling

monthly_rank <- read_csv("monthly_rank.csv", show_col_types = FALSE)  # id, month, rank (1 = highest)
control      <- read_csv("control_variables_23_24_25.csv", show_col_types = FALSE) %>%
  transmute(id = as.character(id), age, observability)

is_disallowed <- function(x) {
  bad <- c("FUN","MUN","SAMUN","JVUN","JVMUN","INFANT")
  !is.na(x) & (x %in% bad | grepl("\\(F\\)$", x))
}
is_male_id <- function(x) !is.na(x) & !is_disallowed(x) & grepl("^[A-Za-z0-9]+$", x)

parse_date_any <- function(x) {
  if (inherits(x, "Date"))   return(x)
  if (inherits(x, "POSIXt")) return(as.Date(x))
  if (is.numeric(x)) {
    ymd_guess <- suppressWarnings(lubridate::ymd(as.character(x)))
    if (mean(!is.na(ymd_guess)) > 0.8) return(ymd_guess)
    d <- as.Date(x, origin = "1899-12-30")
    if (stats::median(d, na.rm = TRUE) < as.Date("1950-01-01")) d <- as.Date(x, origin = "1904-01-01")
    return(d)
  }
  if (is.character(x)) {
    d <- suppressWarnings(lubridate::mdy(x))
    nas <- is.na(d); if (any(nas)) d[nas] <- suppressWarnings(lubridate::dmy(x[nas]))
    nas <- is.na(d); if (any(nas)) d[nas] <- suppressWarnings(lubridate::ymd(x[nas]))
    return(d)
  }
  stop("Unknown date type.")
}

expand_pairs <- function(df) {
  df %>%
    mutate(row_id = dplyr::row_number()) %>%
    pivot_longer(c(actor1, actor2, actor3),     names_to="actor_slot", values_to="actor") %>%
    pivot_longer(c(recipient1, recipient2, recipient3), names_to="recip_slot", values_to="recipient") %>%
    filter(!is.na(actor), !is.na(recipient), actor != recipient)
}

N_by_month <- monthly_rank %>%
  group_by(month) %>%
  summarise(N = max(rank, na.rm = TRUE), .groups = "drop")



## Coalitions with Higher Rank

coal_raw <- read_csv("raw_male_coalition_mount_23_24_25.csv", show_col_types = FALSE)

build_coal_unique <- function() {
  coal <- coal_raw %>%
    mutate(date_dt = parse_date_any(date),
           month   = floor_date(date_dt, "month"),
           event_id = dplyr::row_number()) %>%
    filter(!is.na(month), month(month) %in% 1:5, action == "Ag")
  
  actors_long <- coal %>%
    pivot_longer(c(actor1, actor2, actor3), names_to = "slot", values_to = "id") %>%
    filter(is_male_id(id)) %>%
    transmute(event_id, month, side = "actor_side", id)
  
  recips_long <- coal %>%
    pivot_longer(c(recipient1, recipient2, recipient3), names_to = "slot", values_to = "id") %>%
    filter(is_male_id(id)) %>%
    transmute(event_id, month, side = "recipient_side", id)
  
  parts <- bind_rows(actors_long, recips_long)
  
  pairs_undirected <- parts %>%
    inner_join(parts, by = c("event_id","side"), suffix = c("_1","_2")) %>%
    filter(id_1 < id_2) %>%
    transmute(event_id, month = month_1, id1 = id_1, id2 = id_2)
  
  pairs_dir <- bind_rows(
    pairs_undirected %>% transmute(month, id = id1, partner = id2),
    pairs_undirected %>% transmute(month, id = id2, partner = id1)
  )
  
  coal_ranked <- pairs_dir %>%
    left_join(monthly_rank %>% select(id, month, rank) %>% rename(rank_id = rank),
              by = c("id","month")) %>%
    left_join(monthly_rank %>% select(id, month, rank) %>% rename(partner = id, rank_partner = rank),
              by = c("partner","month")) %>%
    left_join(N_by_month, by = "month") %>%
    filter(!is.na(rank_id), !is.na(rank_partner), !is.na(N), N >= 2) %>%
    mutate(
      higher_partner   = as.integer(rank_partner < rank_id),
      rank_id_pct      = 1 - (rank_id - 1)     / (N - 1),
      rank_partner_pct = 1 - (rank_partner - 1)/ (N - 1),
      abs_diff_pct     = abs(rank_partner_pct - rank_id_pct)
    )
  
  coal_unique_month <- coal_ranked %>%
    distinct(id, partner, month, higher_partner, abs_diff_pct) %>%
    group_by(id, month) %>%
    summarise(
      higher_unique       = sum(higher_partner, na.rm = TRUE),
      mean_abs_diff_pct_unique = mean(abs_diff_pct, na.rm = TRUE),
      unique_total        = n(),
      .groups = "drop"
    ) %>%
    filter(unique_total > 0)
  
  coal_unique_month
}

coal_unique_month <- build_coal_unique()


# SSB

monthly_ssb <- read_csv("monthly_ssb_count_only.csv", show_col_types = FALSE) %>%
  mutate(id = as.character(id), month = as.Date(month))

dat_coal_ssb <- coal_unique_month %>%
  left_join(monthly_ssb %>% select(id, month, ssb_count), by = c("id","month")) %>%
  left_join(control, by = "id") %>%
  mutate(
    ssb_count       = coalesce(as.integer(ssb_count), 0L),
    age_z           = as.numeric(scale(age)),
    observability_z = as.numeric(scale(observability))
  )

m_coal_gap_unique_ssb <- glmmTMB(
  mean_abs_diff_pct_unique ~ ssb_count + age_z + observability_z + (1|id),
  data = dat_coal_ssb,
  family = gaussian(),
  weights = unique_total
)
summary(m_coal_gap_unique_ssb)


# DSB
monthly_dsb <- read_csv("monthly_dsb_count_only.csv", show_col_types = FALSE) %>%
  mutate(id = as.character(id), month = as.Date(month))

dat_coal_dsb <- coal_unique_month %>%
  left_join(monthly_dsb %>% select(id, month, dsb_count), by = c("id","month")) %>%
  left_join(control, by = "id") %>%
  mutate(
    dsb_count       = coalesce(as.integer(dsb_count), 0L),
    age_z           = as.numeric(scale(age)),
    observability_z = as.numeric(scale(observability))
  )

m_coal_gap_unique_dsb <- glmmTMB(
  mean_abs_diff_pct_unique ~ dsb_count + age_z + observability_z + (1|id),
  data = dat_coal_dsb,
  family = gaussian(),
  weights = unique_total
)
summary(m_coal_gap_unique_dsb)


# Total Mounts
monthly_total <- read_csv("monthly_total_mounts_from_aggression.csv", show_col_types = FALSE) %>%
  mutate(id = as.character(id), month = as.Date(month))

dat_coal_total <- coal_unique_month %>%
  left_join(monthly_total %>% select(id, month, total_mounts), by = c("id","month")) %>%
  left_join(control, by = "id") %>%
  mutate(
    total_mounts    = coalesce(as.integer(total_mounts), 0L),
    age_z           = as.numeric(scale(age)),
    observability_z = as.numeric(scale(observability))
  )

m_coal_gap_unique_total <- glmmTMB(
  mean_abs_diff_pct_unique ~ total_mounts + age_z + observability_z + (1|id),
  data = dat_coal_total,
  family = gaussian(),
  weights = unique_total
)
summary(m_coal_gap_unique_total)



## Groom with Higher Rank

groom_raw <- read_csv("raw_groom_mount_23_24_25.csv", show_col_types = FALSE)

build_groom_unique <- function() {
  groom <- groom_raw %>%
    mutate(date_dt = parse_date_any(date),
           month   = floor_date(date_dt, "month")) %>%
    filter(!is.na(month), month(month) %in% 1:5)
  
  gr_pairs_raw <- groom %>%
    filter(action == "Gr") %>%
    select(month, actor1, actor2, actor3, recipient1, recipient2, recipient3) %>%
    expand_pairs() %>%
    filter(is_male_id(actor) & is_male_id(recipient))
  
  gr_pairs_any <- bind_rows(
    gr_pairs_raw %>% transmute(id = actor,     partner = recipient, month),
    gr_pairs_raw %>% transmute(id = recipient, partner = actor,     month)
  )
  
  gr_ranked <- gr_pairs_any %>%
    left_join(monthly_rank %>% select(id, month, rank) %>% rename(rank_id = rank),
              by = c("id","month")) %>%
    left_join(monthly_rank %>% select(id, month, rank) %>% rename(partner = id, rank_partner = rank),
              by = c("partner","month")) %>%
    left_join(N_by_month, by = "month") %>%
    filter(!is.na(rank_id), !is.na(rank_partner), !is.na(N), N >= 2) %>%
    mutate(
      higher_partner   = as.integer(rank_partner < rank_id),
      rank_id_pct      = 1 - (rank_id - 1)     / (N - 1),
      rank_partner_pct = 1 - (rank_partner - 1)/ (N - 1),
      abs_diff_pct     = abs(rank_partner_pct - rank_id_pct)
    )
  
  gr_unique_month <- gr_ranked %>%
    distinct(id, partner, month, higher_partner, abs_diff_pct) %>%
    group_by(id, month) %>%
    summarise(
      higher_unique            = sum(higher_partner, na.rm = TRUE),
      mean_abs_diff_pct_unique = mean(abs_diff_pct, na.rm = TRUE),
      unique_total             = n(),
      .groups = "drop"
    ) %>%
    filter(unique_total > 0)
  
  gr_unique_month
}

gr_unique_month <- build_groom_unique()


# SSB
dat_groom_ssb <- gr_unique_month %>%
  left_join(monthly_ssb %>% select(id, month, ssb_count), by = c("id","month")) %>%
  left_join(control, by = "id") %>%
  mutate(
    ssb_count       = coalesce(as.integer(ssb_count), 0L),
    age_z           = as.numeric(scale(age)),
    observability_z = as.numeric(scale(observability))
  )

m_groom_gap_unique_ssb <- glmmTMB(
  mean_abs_diff_pct_unique ~ ssb_count + age_z + observability_z + (1|id),
  data = dat_groom_ssb,
  family = gaussian(),
  weights = unique_total
)
summary(m_groom_gap_unique_ssb)


# DSB
dat_groom_dsb <- gr_unique_month %>%
  left_join(monthly_dsb %>% select(id, month, dsb_count), by = c("id","month")) %>%
  left_join(control, by = "id") %>%
  mutate(
    dsb_count       = coalesce(as.integer(dsb_count), 0L),
    age_z           = as.numeric(scale(age)),
    observability_z = as.numeric(scale(observability))
  )

m_groom_gap_unique_dsb <- glmmTMB(
  mean_abs_diff_pct_unique ~ dsb_count + age_z + observability_z + (1|id),
  data = dat_groom_dsb,
  family = gaussian(),
  weights = unique_total
)
summary(m_groom_gap_unique_dsb)


# Total Mounts
dat_groom_total <- gr_unique_month %>%
  left_join(monthly_total %>% select(id, month, total_mounts), by = c("id","month")) %>%
  left_join(control, by = "id") %>%
  mutate(
    total_mounts    = coalesce(as.integer(total_mounts), 0L),
    age_z           = as.numeric(scale(age)),
    observability_z = as.numeric(scale(observability))
  )

m_groom_gap_unique_total <- glmmTMB(
  mean_abs_diff_pct_unique ~ total_mounts + age_z + observability_z + (1|id),
  data = dat_groom_total,
  family = gaussian(),
  weights = unique_total
)
summary(m_groom_gap_unique_total)





### Potential Social Benefits of SSB - Partner Diversity 

## SSB

monthly_ssb <- read_csv("monthly_ssb_count_only.csv", show_col_types = FALSE)
control     <- read_csv("control_variables_23_24_25.csv", show_col_types = FALSE)
groom       <- read_csv("raw_groom_mount_23_24_25.csv", show_col_types = FALSE)

monthly_ssb$id <- as.character(monthly_ssb$id)
control$id     <- as.character(control$id)
if (!inherits(monthly_ssb$month, "Date")) monthly_ssb$month <- as.Date(monthly_ssb$month)

is_disallowed <- function(x) {
  bad <- c("FUN","MUN","SAMUN","JVUN","JVMUN","INFANT")
  !is.na(x) & (x %in% bad | grepl("\\(F\\)", x))
}
is_male_id <- function(x) !is.na(x) & !is_disallowed(x) & grepl("^[A-Za-z0-9]+$", x)

parse_date_any <- function(x) {
  if (inherits(x, "Date"))   return(x)
  if (inherits(x, "POSIXt")) return(as.Date(x))
  if (is.numeric(x)) {
    ymd_guess <- suppressWarnings(ymd(as.character(x)))
    if (sum(!is.na(ymd_guess)) > 0.8 * length(x)) return(ymd_guess)
    d <- as.Date(x, origin = "1899-12-30")
    if (median(d, na.rm = TRUE) < as.Date("1950-01-01")) d <- as.Date(x, origin = "1904-01-01")
    return(d)
  }
  if (is.character(x)) {
    d <- suppressWarnings(mdy(x))
    d[is.na(d)] <- suppressWarnings(dmy(x[is_na(d)]))
    d[is.na(d)] <- suppressWarnings(ymd(x[is_na(d)]))
    return(d)
  }
  stop("Unknown date type in `date` column.")
}

groom <- groom %>%
  mutate(date_dt = parse_date_any(date),
         month   = floor_date(date_dt, "month")) %>%
  filter(!is.na(month), month(month) %in% 1:5)

expand_pairs <- function(df) {
  df %>%
    mutate(row_id = dplyr::row_number()) %>%
    pivot_longer(c(actor1, actor2, actor3), names_to = "actor_slot", values_to = "actor") %>%
    pivot_longer(c(recipient1, recipient2, recipient3), names_to = "recip_slot", values_to = "recipient") %>%
    filter(!is.na(actor), !is.na(recipient), actor != recipient)
}

groom_rows <- groom %>%
  filter(action == "Gr") %>%
  select(month, actor1, actor2, actor3, recipient1, recipient2, recipient3)

groom_pairs <- expand_pairs(groom_rows)

groom_deg_male <- groom_pairs %>%
  mutate(recipient_is_male = is_male_id(recipient)) %>%
  group_by(actor, month) %>%
  summarise(
    degree_male = n_distinct(recipient[recipient_is_male]),  
    gr_count    = n(),                                       
    .groups = "drop"
  ) %>%
  rename(id = actor)

write_csv(groom_deg_male, "groom_degree_male.csv")

id_month_base <- monthly_ssb %>% select(id, month) %>% distinct()

dat_diversity <- id_month_base %>%
  left_join(groom_deg_male, by = c("id","month")) %>%
  left_join(monthly_ssb %>% select(id, month, ssb_count), by = c("id","month")) %>%
  left_join(control %>% select(id, age, observability), by = "id") %>%
  mutate(
    degree_male     = ifelse(is.na(degree_male), 0L, as.integer(degree_male)),
    gr_count        = ifelse(is.na(gr_count),    0L, as.integer(gr_count)),
    ssb_count       = ifelse(is.na(ssb_count),   0L, as.integer(ssb_count)),
    age_z           = as.numeric(scale(age)),
    observability_z = as.numeric(scale(observability)),
    exposure_gr     = pmax(gr_count, 1L)  # offset for grooming effort
  )

write_csv(dat_diversity, "dat_partner_diversity_ssb_count.csv")

m_div_ssb_count <- glmmTMB(
  degree_male ~ ssb_count + age_z + observability_z +
    offset(log(exposure_gr)),
  data   = dat_diversity %>% filter(!is.na(age_z), !is.na(observability_z)),
  family = poisson(link = "log")
)
summary(m_div_ssb_count)



## DSB

monthly_dsb <- read_csv("monthly_dsb_count_only.csv", show_col_types = FALSE)
control     <- read_csv("control_variables_23_24_25.csv", show_col_types = FALSE)
groom       <- read_csv("raw_groom_mount_23_24_25.csv", show_col_types = FALSE)

monthly_dsb$id <- as.character(monthly_dsb$id)
control$id     <- as.character(control$id)
if (!inherits(monthly_dsb$month, "Date")) monthly_dsb$month <- as.Date(monthly_dsb$month)

is_disallowed <- function(x) {
  bad <- c("FUN","MUN","SAMUN","JVUN","JVMUN","INFANT")
  !is.na(x) & (x %in% bad | grepl("\\(F\\)", x))
}
is_male_id <- function(x) !is.na(x) & !is_disallowed(x) & grepl("^[A-Za-z0-9]+$", x)

parse_date_any <- function(x) {
  if (inherits(x, "Date"))   return(x)
  if (inherits(x, "POSIXt")) return(as.Date(x))
  if (is.numeric(x)) {
    ymd_guess <- suppressWarnings(ymd(as.character(x)))
    if (sum(!is.na(ymd_guess)) > 0.8 * length(x)) return(ymd_guess)
    d <- as.Date(x, origin = "1899-12-30")
    if (median(d, na.rm = TRUE) < as.Date("1950-01-01")) d <- as.Date(x, origin = "1904-01-01")
    return(d)
  }
  if (is.character(x)) {
    d <- suppressWarnings(mdy(x))
    d[is.na(d)] <- suppressWarnings(dmy(x[is.na(d)]))
    d[is.na(d)] <- suppressWarnings(ymd(x[is.na(d)]))
    return(d)
  }
  stop("Unknown date type in `date` column.")
}

groom <- groom %>%
  mutate(date_dt = parse_date_any(date),
         month   = floor_date(date_dt, "month")) %>%
  filter(!is.na(month), month(month) %in% 1:5)

expand_pairs <- function(df) {
  df %>%
    mutate(row_id = dplyr::row_number()) %>%
    pivot_longer(c(actor1, actor2, actor3), names_to = "actor_slot", values_to = "actor") %>%
    pivot_longer(c(recipient1, recipient2, recipient3), names_to = "recip_slot", values_to = "recipient") %>%
    filter(!is.na(actor), !is.na(recipient), actor != recipient)
}

groom_rows <- groom %>%
  filter(action == "Gr") %>%
  select(month, actor1, actor2, actor3, recipient1, recipient2, recipient3)

groom_pairs <- expand_pairs(groom_rows)

groom_deg_male <- groom_pairs %>%
  mutate(recipient_is_male = is_male_id(recipient)) %>%
  group_by(actor, month) %>%
  summarise(
    degree_male = n_distinct(recipient[recipient_is_male]),
    gr_count    = n(),
    .groups = "drop"
  ) %>%
  rename(id = actor)

write_csv(groom_deg_male, "groom_degree_male.csv")

id_month_base <- monthly_dsb %>% select(id, month) %>% distinct()

dat_diversity <- id_month_base %>%
  left_join(groom_deg_male, by = c("id","month")) %>%
  left_join(monthly_dsb %>% select(id, month, dsb_count), by = c("id","month")) %>%
  left_join(control %>% select(id, age, observability), by = "id") %>%
  mutate(
    degree_male     = ifelse(is.na(degree_male), 0L, as.integer(degree_male)),
    gr_count        = ifelse(is.na(gr_count),    0L, as.integer(gr_count)),
    dsb_count       = ifelse(is.na(dsb_count),   0L, as.integer(dsb_count)),
    age_z           = as.numeric(scale(age)),
    observability_z = as.numeric(scale(observability)),
    exposure_gr     = pmax(gr_count, 1L)
  )

write_csv(dat_diversity, "dat_partner_diversity_dsb_count.csv")

m_div_dsb_count <- glmmTMB(
  degree_male ~ dsb_count + age_z + observability_z +
    offset(log(exposure_gr)),
  data   = dat_diversity %>% filter(!is.na(age_z), !is.na(observability_z)),
  family = poisson(link = "log")
)
summary(m_div_dsb_count)



## Total Mounts

monthly_total <- read_csv("monthly_total_mounts_from_aggression.csv", show_col_types = FALSE)
control       <- read_csv("control_variables_23_24_25.csv",            show_col_types = FALSE)
groom         <- read_csv("raw_groom_mount_23_24_25.csv",              show_col_types = FALSE)

monthly_total$id <- as.character(monthly_total$id)
control$id       <- as.character(control$id)
if (!inherits(monthly_total$month, "Date")) monthly_total$month <- as.Date(monthly_total$month)

is_disallowed <- function(x) {
  bad <- c("FUN","MUN","SAMUN","JVUN","JVMUN","INFANT")
  !is.na(x) & (x %in% bad | grepl("\\(F\\)", x))
}
is_male_id <- function(x) !is.na(x) & !is_disallowed(x) & grepl("^[A-Za-z0-9]+$", x)

parse_date_any <- function(x) {
  if (inherits(x, "Date"))   return(x)
  if (inherits(x, "POSIXt")) return(as.Date(x))
  if (is.numeric(x)) {
    ymd_guess <- suppressWarnings(ymd(as.character(x)))
    if (sum(!is.na(ymd_guess)) > 0.8 * length(x)) return(ymd_guess)
    d <- as.Date(x, origin = "1899-12-30")
    if (median(d, na.rm = TRUE) < as.Date("1950-01-01")) d <- as.Date(x, origin = "1904-01-01")
    return(d)
  }
  if (is.character(x)) {
    d <- suppressWarnings(mdy(x))
    d[is.na(d)] <- suppressWarnings(dmy(x[is.na(d)]))
    d[is.na(d)] <- suppressWarnings(ymd(x[is_na(d)]))
    return(d)
  }
  stop("Unknown date type in `date` column.")
}

groom <- groom %>%
  mutate(date_dt = parse_date_any(date),
         month   = floor_date(date_dt, "month")) %>%
  filter(!is.na(month), month(month) %in% 1:5)

expand_pairs <- function(df) {
  df %>%
    mutate(row_id = dplyr::row_number()) %>%
    pivot_longer(c(actor1, actor2, actor3), names_to = "actor_slot", values_to = "actor") %>%
    pivot_longer(c(recipient1, recipient2, recipient3), names_to = "recip_slot", values_to = "recipient") %>%
    filter(!is.na(actor), !is.na(recipient), actor != recipient)
}

groom_rows <- groom %>%
  filter(action == "Gr") %>%
  select(month, actor1, actor2, actor3, recipient1, recipient2, recipient3)

groom_pairs <- expand_pairs(groom_rows)

groom_deg_male <- groom_pairs %>%
  mutate(recipient_is_male = is_male_id(recipient)) %>%
  group_by(actor, month) %>%
  summarise(
    degree_male = n_distinct(recipient[recipient_is_male]),
    gr_count    = n(),
    .groups = "drop"
  ) %>%
  rename(id = actor)

write_csv(groom_deg_male, "groom_degree_male.csv")

id_month_base <- monthly_total %>% select(id, month) %>% distinct()

dat_diversity <- id_month_base %>%
  left_join(groom_deg_male, by = c("id","month")) %>%
  left_join(monthly_total %>% select(id, month, total_mounts), by = c("id","month")) %>%
  left_join(control %>% select(id, age, observability), by = "id") %>%
  mutate(
    degree_male     = ifelse(is.na(degree_male), 0L, as.integer(degree_male)),
    gr_count        = ifelse(is.na(gr_count),    0L, as.integer(gr_count)),
    total_mounts    = ifelse(is.na(total_mounts),0L, as.integer(total_mounts)),
    age_z           = as.numeric(scale(age)),
    observability_z = as.numeric(scale(observability)),
    exposure_gr     = pmax(gr_count, 1L)
  )

write_csv(dat_diversity, "dat_partner_diversity_total_mounts.csv")

m_div_total_mounts <- glmmTMB(
  degree_male ~ total_mounts + age_z + observability_z +
    offset(log(exposure_gr)),
  data   = dat_diversity %>% filter(!is.na(age_z), !is.na(observability_z)),
  family = poisson(link = "log")
)
summary(m_div_total_mounts)





### Potential Social Benefits of SSB - Cross-Sex Interactions

## SSB

monthly_ssb <- read_csv("monthly_ssb_count_only.csv", show_col_types = FALSE)
control     <- read_csv("control_variables_23_24_25.csv", show_col_types = FALSE)
groom       <- read_csv("raw_groom_mount_23_24_25.csv", show_col_types = FALSE)

monthly_ssb$id <- as.character(monthly_ssb$id)
control$id     <- as.character(control$id)
if (!inherits(monthly_ssb$month, "Date")) monthly_ssb$month <- as.Date(monthly_ssb$month)

is_disallowed <- function(x) {
  bad <- c("FUN","MUN","SAMUN","JVUN","JVMUN","INFANT")
  !is.na(x) & (x %in% bad | grepl("\\(F\\)", x))
}
parse_date_any <- function(x){
  if (inherits(x,"Date")) return(x)
  if (inherits(x,"POSIXt")) return(as.Date(x))
  if (is.numeric(x)){
    ymd_guess <- suppressWarnings(ymd(as.character(x)))
    if (mean(!is.na(ymd_guess))>0.8) return(ymd_guess)
    d <- as.Date(x, origin="1899-12-30")
    if (median(d,na.rm=TRUE) < as.Date("1950-01-01")) d <- as.Date(x, origin="1904-01-01")
    return(d)
  }
  d <- suppressWarnings(mdy(x)); nas <- is.na(d)
  if (any(nas)) d[nas] <- suppressWarnings(dmy(x[nas]))
  nas <- is.na(d); if (any(nas)) d[nas] <- suppressWarnings(ymd(x[nas]))
  d
}

groom <- groom %>%
  mutate(date_dt = parse_date_any(date),
         month   = floor_date(date_dt,"month")) %>%
  filter(!is.na(month), month(month)%in%1:5)

expand_pairs <- function(df){
  df %>%
    mutate(row_id = dplyr::row_number()) %>%
    pivot_longer(c(actor1,actor2,actor3), names_to="actor_slot", values_to="actor") %>%
    pivot_longer(c(recipient1,recipient2,recipient3), names_to="recip_slot", values_to="recipient") %>%
    filter(!is.na(actor), !is.na(recipient), actor!=recipient)
}

groom_rows <- groom %>%
  filter(action=="Gr") %>%
  select(month, actor1, actor2, actor3, recipient1, recipient2, recipient3)

groom_pairs <- expand_pairs(groom_rows)

groom_cross_sex <- groom_pairs %>%
  mutate(recipient_is_female = (!is.na(recipient) & (recipient=="FUN" | grepl("\\(F\\)", recipient)))) %>%
  group_by(actor, month) %>%
  summarise(
    female_gr_count = sum(recipient_is_female, na.rm=TRUE),  
    gr_total        = n(),                                   
    .groups="drop"
  ) %>%
  rename(id = actor)

write_csv(groom_cross_sex, "groom_cross_sex_monthly.csv")

base_months <- bind_rows(
  monthly_ssb %>% select(id, month),
  groom_cross_sex %>% select(id, month)
) %>% distinct()

dat_crossex <- base_months %>%
  left_join(groom_cross_sex, by=c("id","month")) %>%
  left_join(monthly_ssb %>% select(id, month, ssb_count), by=c("id","month")) %>%
  left_join(control %>% select(id, age, observability), by="id") %>%
  mutate(
    female_gr_count = ifelse(is.na(female_gr_count), 0L, as.integer(female_gr_count)),
    gr_total        = ifelse(is.na(gr_total),        0L, as.integer(gr_total)),
    ssb_count       = ifelse(is.na(ssb_count),       0L, as.integer(ssb_count)),
    age_z           = as.numeric(scale(age)),
    observability_z = as.numeric(scale(observability)),
    gr_total_safe   = pmax(gr_total, 1L)
  )

write_csv(dat_crossex, "dat_cross_sex_ssb_count.csv")

m_csex_count_ssbcount <- glmmTMB(
  female_gr_count ~ ssb_count + age_z + observability_z +
    offset(log(gr_total_safe)) + (1|id),
  data   = dat_crossex %>% filter(!is.na(age_z), !is.na(observability_z)),
  family = poisson(link="log")
)
summary(m_csex_count_ssbcount)



## DSB 

monthly_dsb <- read_csv("monthly_dsb_count_only.csv", show_col_types = FALSE)
control     <- read_csv("control_variables_23_24_25.csv", show_col_types = FALSE)
groom       <- read_csv("raw_groom_mount_23_24_25.csv", show_col_types = FALSE)

monthly_dsb$id <- as.character(monthly_dsb$id)
control$id     <- as.character(control$id)
if (!inherits(monthly_dsb$month, "Date")) monthly_dsb$month <- as.Date(monthly_dsb$month)

parse_date_any <- function(x){  
  if (inherits(x,"Date")) return(x)
  if (inherits(x,"POSIXt")) return(as.Date(x))
  if (is.numeric(x)){
    ymd_guess <- suppressWarnings(ymd(as.character(x)))
    if (mean(!is.na(ymd_guess))>0.8) return(ymd_guess)
    d <- as.Date(x, origin="1899-12-30")
    if (median(d,na.rm=TRUE) < as.Date("1950-01-01")) d <- as.Date(x, origin="1904-01-01")
    return(d)
  }
  d <- suppressWarnings(mdy(x)); nas <- is.na(d)
  if (any(nas)) d[nas] <- suppressWarnings(dmy(x[nas]))
  nas <- is.na(d); if (any(nas)) d[nas] <- suppressWarnings(ymd(x[nas]))
  d
}

groom <- groom %>%
  mutate(date_dt = parse_date_any(date),
         month   = floor_date(date_dt,"month")) %>%
  filter(!is.na(month), month(month)%in%1:5)

expand_pairs <- function(df){
  df %>%
    mutate(row_id = dplyr::row_number()) %>%
    pivot_longer(c(actor1,actor2,actor3), names_to="actor_slot", values_to="actor") %>%
    pivot_longer(c(recipient1,recipient2,recipient3), names_to="recip_slot", values_to="recipient") %>%
    filter(!is.na(actor), !is.na(recipient), actor!=recipient)
}

groom_rows <- groom %>%
  filter(action=="Gr") %>%
  select(month, actor1, actor2, actor3, recipient1, recipient2, recipient3)

groom_pairs <- expand_pairs(groom_rows)

groom_cross_sex <- groom_pairs %>%
  mutate(recipient_is_female = (!is.na(recipient) & (recipient=="FUN" | grepl("\\(F\\)", recipient)))) %>%
  group_by(actor, month) %>%
  summarise(
    female_gr_count = sum(recipient_is_female, na.rm=TRUE),
    gr_total        = n(),
    .groups="drop"
  ) %>%
  rename(id = actor)

write_csv(groom_cross_sex, "groom_cross_sex_monthly.csv")

base_months <- bind_rows(
  monthly_dsb %>% select(id, month),
  groom_cross_sex %>% select(id, month)
) %>% distinct()

dat_crossex <- base_months %>%
  left_join(groom_cross_sex, by=c("id","month")) %>%
  left_join(monthly_dsb %>% select(id, month, dsb_count), by=c("id","month")) %>%
  left_join(control %>% select(id, age, observability), by="id") %>%
  mutate(
    female_gr_count = ifelse(is.na(female_gr_count), 0L, as.integer(female_gr_count)),
    gr_total        = ifelse(is.na(gr_total),        0L, as.integer(gr_total)),
    dsb_count       = ifelse(is.na(dsb_count),       0L, as.integer(dsb_count)),
    age_z           = as.numeric(scale(age)),
    observability_z = as.numeric(scale(observability)),
    gr_total_safe   = pmax(gr_total, 1L)
  )

write_csv(dat_crossex, "dat_cross_sex_dsb_count.csv")

m_csex_count_dsbcount <- glmmTMB(
  female_gr_count ~ dsb_count + age_z + observability_z +
    offset(log(gr_total_safe)) + (1|id),
  data   = dat_crossex %>% filter(!is.na(age_z), !is.na(observability_z)),
  family = poisson(link="log")
)
summary(m_csex_count_dsbcount)



## Total Mounts 

monthly_total <- read_csv("monthly_total_mounts_from_aggression.csv", show_col_types = FALSE)
control       <- read_csv("control_variables_23_24_25.csv",            show_col_types = FALSE)
groom         <- read_csv("raw_groom_mount_23_24_25.csv",              show_col_types = FALSE)

monthly_total$id <- as.character(monthly_total$id)
control$id       <- as.character(control$id)
if (!inherits(monthly_total$month, "Date")) monthly_total$month <- as.Date(monthly_total$month)

parse_date_any <- function(x){  
  if (inherits(x,"Date")) return(x)
  if (inherits(x,"POSIXt")) return(as.Date(x))
  if (is.numeric(x)){
    ymd_guess <- suppressWarnings(ymd(as.character(x)))
    if (mean(!is.na(ymd_guess))>0.8) return(ymd_guess)
    d <- as.Date(x, origin="1899-12-30")
    if (median(d,na.rm=TRUE) < as.Date("1950-01-01")) d <- as.Date(x, origin="1904-01-01")
    return(d)
  }
  d <- suppressWarnings(mdy(x)); nas <- is.na(d)
  if (any(nas)) d[nas] <- suppressWarnings(dmy(x[nas]))
  nas <- is.na(d); if (any(nas)) d[nas] <- suppressWarnings(ymd(x[nas]))
  d
}

groom <- groom %>%
  mutate(date_dt = parse_date_any(date),
         month   = floor_date(date_dt,"month")) %>%
  filter(!is.na(month), month(month)%in%1:5)

expand_pairs <- function(df){
  df %>%
    mutate(row_id = dplyr::row_number()) %>%
    pivot_longer(c(actor1,actor2,actor3), names_to="actor_slot", values_to="actor") %>%
    pivot_longer(c(recipient1,recipient2,recipient3), names_to="recip_slot", values_to="recipient") %>%
    filter(!is.na(actor), !is.na(recipient), actor!=recipient)
}

groom_rows <- groom %>%
  filter(action=="Gr") %>%
  select(month, actor1, actor2, actor3, recipient1, recipient2, recipient3)

groom_pairs <- expand_pairs(groom_rows)

groom_cross_sex <- groom_pairs %>%
  mutate(recipient_is_female = (!is.na(recipient) & (recipient=="FUN" | grepl("\\(F\\)", recipient)))) %>%
  group_by(actor, month) %>%
  summarise(
    female_gr_count = sum(recipient_is_female, na.rm=TRUE),
    gr_total        = n(),
    .groups="drop"
  ) %>%
  rename(id = actor)

write_csv(groom_cross_sex, "groom_cross_sex_monthly.csv")

base_months <- bind_rows(
  monthly_total %>% select(id, month),
  groom_cross_sex %>% select(id, month)
) %>% distinct()

dat_crossex <- base_months %>%
  left_join(groom_cross_sex, by=c("id","month")) %>%
  left_join(monthly_total %>% select(id, month, total_mounts), by=c("id","month")) %>%
  left_join(control %>% select(id, age, observability), by="id") %>%
  mutate(
    female_gr_count = ifelse(is.na(female_gr_count), 0L, as.integer(female_gr_count)),
    gr_total        = ifelse(is.na(gr_total),        0L, as.integer(gr_total)),
    total_mounts    = ifelse(is.na(total_mounts),    0L, as.integer(total_mounts)),
    age_z           = as.numeric(scale(age)),
    observability_z = as.numeric(scale(observability)),
    gr_total_safe   = pmax(gr_total, 1L)
  )

write_csv(dat_crossex, "dat_cross_sex_total_mounts.csv")

m_csex_count_total <- glmmTMB(
  female_gr_count ~ total_mounts + age_z + observability_z +
    offset(log(gr_total_safe)) + (1|id),
  data   = dat_crossex %>% filter(!is.na(age_z), !is.na(observability_z)),
  family = poisson(link="log")
)
summary(m_csex_count_total)





### Potential Social Benefits of SSB - Bond Persistence

## SSB

monthly_ssb <- read_csv("monthly_ssb_count_only.csv", show_col_types = FALSE)
control     <- read_csv("control_variables_23_24_25.csv", show_col_types = FALSE)
groom       <- read_csv("raw_groom_mount_23_24_25.csv", show_col_types = FALSE)

monthly_ssb$id <- as.character(monthly_ssb$id)
control$id     <- as.character(control$id)
if (!inherits(monthly_ssb$month, "Date")) monthly_ssb$month <- as.Date(monthly_ssb$month)

is_disallowed <- function(x) {
  bad <- c("FUN","MUN","SAMUN","JVUN","JVMUN","INFANT")
  !is.na(x) & (x %in% bad | grepl("\\(F\\)", x))
}
is_male_id <- function(x) !is.na(x) & !is_disallowed(x) & grepl("^[A-Za-z0-9]+$", x)

parse_date_any <- function(x){
  if (inherits(x,"Date")) return(x)
  if (inherits(x,"POSIXt")) return(as.Date(x))
  if (is.numeric(x)){
    ymd_guess <- suppressWarnings(ymd(as.character(x)))
    if (mean(!is.na(ymd_guess))>0.8) return(ymd_guess)
    d <- as.Date(x, origin="1899-12-30")
    if (median(d,na.rm=TRUE) < as.Date("1950-01-01")) d <- as.Date(x, origin="1904-01-01")
    return(d)
  }
  d <- suppressWarnings(mdy(x)); nas <- is.na(d)
  if (any(nas)) d[nas] <- suppressWarnings(dmy(x[nas]))
  nas <- is.na(d); if (any(nas)) d[nas] <- suppressWarnings(ymd(x[nas]))
  d
}

expand_pairs <- function(df){
  df %>%
    mutate(row_id = dplyr::row_number()) %>%
    pivot_longer(c(actor1,actor2,actor3), names_to="actor_slot", values_to="actor") %>%
    pivot_longer(c(recipient1,recipient2,recipient3), names_to="recip_slot", values_to="recipient") %>%
    filter(!is.na(actor), !is.na(recipient), actor!=recipient)
}

groom <- groom %>%
  mutate(date_dt = parse_date_any(date),
         month   = floor_date(date_dt,"month")) %>%
  filter(!is.na(month), month(month)%in%1:5)

groom_pairs <- groom %>%
  filter(action=="Gr") %>%
  select(month, actor1, actor2, actor3, recipient1, recipient2, recipient3) %>%
  expand_pairs() %>%
  filter(is_male_id(actor) & is_male_id(recipient)) %>%
  transmute(month, id1 = pmin(actor,recipient), id2 = pmax(actor,recipient))

dyad_month <- groom_pairs %>%
  group_by(id1, id2, month) %>%
  summarise(gr_events = n(), present = as.integer(gr_events>0), .groups="drop") %>%
  mutate(dyad = paste(id1, id2, sep="_"))

write_csv(dyad_month, "groom_dyad_monthly_presence.csv")

available_months <- sort(unique(dyad_month$month))

dyad_t  <- dyad_month %>%
  mutate(month_t1 = month %m+% months(1)) %>%
  filter(month_t1 %in% available_months)

dyad_t1 <- dyad_month %>%
  transmute(dyad, month_t1 = month, present_t1 = present)

persist_base <- dyad_t %>%
  filter(present == 1) %>%
  left_join(dyad_t1, by=c("dyad","month_t1")) %>%
  mutate(persist = ifelse(is.na(present_t1), 0L, present_t1))

ssb_t_1 <- monthly_ssb %>% select(id, month, ssb_count) %>% rename(id1=id, ssb_count_1=ssb_count)
ssb_t_2 <- monthly_ssb %>% select(id, month, ssb_count) %>% rename(id2=id, ssb_count_2=ssb_count)

persist_dat <- persist_base %>%
  left_join(ssb_t_1, by=c("id1","month")) %>%
  left_join(ssb_t_2, by=c("id2","month")) %>%
  left_join(control %>% select(id, age, observability) %>% rename(id1=id, age1=age, obs1=observability), by="id1") %>%
  left_join(control %>% select(id, age, observability) %>% rename(id2=id, age2=age, obs2=observability), by="id2") %>%
  mutate(
    ssb_count_1    = coalesce(as.integer(ssb_count_1), 0L),
    ssb_count_2    = coalesce(as.integer(ssb_count_2), 0L),
    ssb_count_sum  = ssb_count_1 + ssb_count_2,
    age_mean        = rowMeans(cbind(age1, age2), na.rm=TRUE),
    observability_m = rowMeans(cbind(obs1, obs2), na.rm=TRUE),
    age_z           = as.numeric(scale(age_mean)),
    observability_z = as.numeric(scale(observability_m))
  )

write_csv(persist_dat, "dat_bond_persistence_ssb_count.csv")

m_persist_ssbcount <- glmmTMB(
  persist ~ ssb_count_sum + age_z + observability_z + (1|dyad),
  data   = persist_dat %>% filter(!is.na(persist), !is.na(ssb_count_sum), !is.na(age_z), !is.na(observability_z)),
  family = binomial(link="logit")
)
summary(m_persist_ssbcount)



## DSB

monthly_dsb <- read_csv("monthly_dsb_count_only.csv", show_col_types = FALSE)
control     <- read_csv("control_variables_23_24_25.csv", show_col_types = FALSE)
groom       <- read_csv("raw_groom_mount_23_24_25.csv", show_col_types = FALSE)

monthly_dsb$id <- as.character(monthly_dsb$id)
control$id     <- as.character(control$id)
if (!inherits(monthly_dsb$month, "Date")) monthly_dsb$month <- as.Date(monthly_dsb$month)

is_disallowed <- function(x) {
  bad <- c("FUN","MUN","SAMUN","JVUN","JVMUN","INFANT")
  !is.na(x) & (x %in% bad | grepl("\\(F\\)", x))
}
is_male_id <- function(x) !is.na(x) & !is_disallowed(x) & grepl("^[A-Za-z0-9]+$", x)

parse_date_any <- function(x){  # same as above
  if (inherits(x,"Date")) return(x)
  if (inherits(x,"POSIXt")) return(as.Date(x))
  if (is.numeric(x)){
    ymd_guess <- suppressWarnings(ymd(as.character(x)))
    if (mean(!is.na(ymd_guess))>0.8) return(ymd_guess)
    d <- as.Date(x, origin="1899-12-30")
    if (median(d,na.rm=TRUE) < as.Date("1950-01-01")) d <- as.Date(x, origin="1904-01-01")
    return(d)
  }
  d <- suppressWarnings(mdy(x)); nas <- is.na(d)
  if (any(nas)) d[nas] <- suppressWarnings(dmy(x[nas]))
  nas <- is.na(d); if (any(nas)) d[nas] <- suppressWarnings(ymd(x[nas]))
  d
}

expand_pairs <- function(df){
  df %>%
    mutate(row_id = dplyr::row_number()) %>%
    pivot_longer(c(actor1,actor2,actor3), names_to="actor_slot", values_to="actor") %>%
    pivot_longer(c(recipient1,recipient2,recipient3), names_to="recip_slot", values_to="recipient") %>%
    filter(!is.na(actor), !is.na(recipient), actor!=recipient)
}

groom <- groom %>%
  mutate(date_dt = parse_date_any(date),
         month   = floor_date(date_dt,"month")) %>%
  filter(!is.na(month), month(month)%in%1:5)

groom_pairs <- groom %>%
  filter(action=="Gr") %>%
  select(month, actor1, actor2, actor3, recipient1, recipient2, recipient3) %>%
  expand_pairs() %>%
  filter(is_male_id(actor) & is_male_id(recipient)) %>%
  transmute(month, id1 = pmin(actor,recipient), id2 = pmax(actor,recipient))

dyad_month <- groom_pairs %>%
  group_by(id1, id2, month) %>%
  summarise(gr_events = n(), present = as.integer(gr_events>0), .groups="drop") %>%
  mutate(dyad = paste(id1, id2, sep="_"))

write_csv(dyad_month, "groom_dyad_monthly_presence.csv")

available_months <- sort(unique(dyad_month$month))

dyad_t  <- dyad_month %>%
  mutate(month_t1 = month %m+% months(1)) %>%
  filter(month_t1 %in% available_months)

dyad_t1 <- dyad_month %>%
  transmute(dyad, month_t1 = month, present_t1 = present)

persist_base <- dyad_t %>%
  filter(present == 1) %>%
  left_join(dyad_t1, by=c("dyad","month_t1")) %>%
  mutate(persist = ifelse(is.na(present_t1), 0L, present_t1))

dsb_t_1 <- monthly_dsb %>% select(id, month, dsb_count) %>% rename(id1=id, dsb_count_1=dsb_count)
dsb_t_2 <- monthly_dsb %>% select(id, month, dsb_count) %>% rename(id2=id, dsb_count_2=dsb_count)

persist_dat <- persist_base %>%
  left_join(dsb_t_1, by=c("id1","month")) %>%
  left_join(dsb_t_2, by=c("id2","month")) %>%
  left_join(control %>% select(id, age, observability) %>% rename(id1=id, age1=age, obs1=observability), by="id1") %>%
  left_join(control %>% select(id, age, observability) %>% rename(id2=id, age2=age, obs2=observability), by="id2") %>%
  mutate(
    dsb_count_1    = coalesce(as.integer(dsb_count_1), 0L),
    dsb_count_2    = coalesce(as.integer(dsb_count_2), 0L),
    dsb_count_sum  = dsb_count_1 + dsb_count_2,
    age_mean        = rowMeans(cbind(age1, age2), na.rm=TRUE),
    observability_m = rowMeans(cbind(obs1, obs2), na.rm=TRUE),
    age_z           = as.numeric(scale(age_mean)),
    observability_z = as.numeric(scale(observability_m))
  )

write_csv(persist_dat, "dat_bond_persistence_dsb_count.csv")

m_persist_dsbcount <- glmmTMB(
  persist ~ dsb_count_sum + age_z + observability_z + (1|dyad),
  data   = persist_dat %>% filter(!is.na(persist), !is.na(dsb_count_sum), !is.na(age_z), !is.na(observability_z)),
  family = binomial(link="logit")
)
summary(m_persist_dsbcount)



## Total Mounts

monthly_total <- read_csv("monthly_total_mounts_from_aggression.csv", show_col_types = FALSE)
control       <- read_csv("control_variables_23_24_25.csv",            show_col_types = FALSE)
groom         <- read_csv("raw_groom_mount_23_24_25.csv",              show_col_types = FALSE)

monthly_total$id <- as.character(monthly_total$id)
control$id       <- as.character(control$id)
if (!inherits(monthly_total$month, "Date")) monthly_total$month <- as.Date(monthly_total$month)

is_disallowed <- function(x) {
  bad <- c("FUN","MUN","SAMUN","JVUN","JVMUN","INFANT")
  !is.na(x) & (x %in% bad | grepl("\\(F\\)", x))
}
is_male_id <- function(x) !is.na(x) & !is_disallowed(x) & grepl("^[A-Za-z0-9]+$", x)

parse_date_any <- function(x){  # same as above
  if (inherits(x,"Date")) return(x)
  if (inherits(x,"POSIXt")) return(as.Date(x))
  if (is.numeric(x)){
    ymd_guess <- suppressWarnings(ymd(as.character(x)))
    if (mean(!is.na(ymd_guess))>0.8) return(ymd_guess)
    d <- as.Date(x, origin="1899-12-30")
    if (median(d,na.rm=TRUE) < as.Date("1950-01-01")) d <- as.Date(x, origin="1904-01-01")
    return(d)
  }
  d <- suppressWarnings(mdy(x)); nas <- is.na(d)
  if (any(nas)) d[nas] <- suppressWarnings(dmy(x[nas]))
  nas <- is.na(d); if (any(nas)) d[nas] <- suppressWarnings(ymd(x[nas]))
  d
}

expand_pairs <- function(df){
  df %>%
    mutate(row_id = dplyr::row_number()) %>%
    pivot_longer(c(actor1,actor2,actor3), names_to="actor_slot", values_to="actor") %>%
    pivot_longer(c(recipient1,recipient2,recipient3), names_to="recip_slot", values_to="recipient") %>%
    filter(!is.na(actor), !is.na(recipient), actor!=recipient)
}

groom <- groom %>%
  mutate(date_dt = parse_date_any(date),
         month   = floor_date(date_dt,"month")) %>%
  filter(!is.na(month), month(month)%in%1:5)

groom_pairs <- groom %>%
  filter(action=="Gr") %>%
  select(month, actor1, actor2, actor3, recipient1, recipient2, recipient3) %>%
  expand_pairs() %>%
  filter(is_male_id(actor) & is_male_id(recipient)) %>%
  transmute(month, id1 = pmin(actor,recipient), id2 = pmax(actor,recipient))

dyad_month <- groom_pairs %>%
  group_by(id1, id2, month) %>%
  summarise(gr_events = n(), present = as.integer(gr_events>0), .groups="drop") %>%
  mutate(dyad = paste(id1, id2, sep="_"))

write_csv(dyad_month, "groom_dyad_monthly_presence.csv")

available_months <- sort(unique(dyad_month$month))

dyad_t  <- dyad_month %>%
  mutate(month_t1 = month %m+% months(1)) %>%
  filter(month_t1 %in% available_months)

dyad_t1 <- dyad_month %>%
  transmute(dyad, month_t1 = month, present_t1 = present)

persist_base <- dyad_t %>%
  filter(present == 1) %>%
  left_join(dyad_t1, by=c("dyad","month_t1")) %>%
  mutate(persist = ifelse(is.na(present_t1), 0L, present_t1))

tm_1 <- monthly_total %>% select(id, month, total_mounts) %>% rename(id1=id, total_mounts_1=total_mounts)
tm_2 <- monthly_total %>% select(id, month, total_mounts) %>% rename(id2=id, total_mounts_2=total_mounts)

persist_dat <- persist_base %>%
  left_join(tm_1, by=c("id1","month")) %>%
  left_join(tm_2, by=c("id2","month")) %>%
  left_join(control %>% select(id, age, observability) %>% rename(id1=id, age1=age, obs1=observability), by="id1") %>%
  left_join(control %>% select(id, age, observability) %>% rename(id2=id, age2=age, obs2=observability), by="id2") %>%
  mutate(
    total_mounts_1   = coalesce(as.integer(total_mounts_1), 0L),
    total_mounts_2   = coalesce(as.integer(total_mounts_2), 0L),
    total_mounts_sum = total_mounts_1 + total_mounts_2,
    age_mean         = rowMeans(cbind(age1, age2), na.rm=TRUE),
    observability_m  = rowMeans(cbind(obs1, obs2), na.rm=TRUE),
    age_z            = as.numeric(scale(age_mean)),
    observability_z  = as.numeric(scale(observability_m))
  )

write_csv(persist_dat, "dat_bond_persistence_total_mounts.csv")

m_persist_total <- glmmTMB(
  persist ~ total_mounts_sum + age_z + observability_z + (1|dyad),
  data   = persist_dat %>% filter(!is.na(persist), !is.na(total_mounts_sum), !is.na(age_z), !is.na(observability_z)),
  family = binomial(link="logit")
)
summary(m_persist_total)





### Inter-Observer-Reliability ###

dat <- read_csv("ior_23-25_organised_collapsed.csv", show_col_types = FALSE)

bad_obs1 <- dat$obs1_action != "none" & (is.na(dat$obs1_actor) | is.na(dat$obs1_recipient))
bad_obs2 <- dat$obs2_action != "none" & (is.na(dat$obs2_actor) | is.na(dat$obs2_recipient))
dat_clean <- dat[!(bad_obs1 | bad_obs2), ] %>% filter(!is.na(obs1), !is.na(obs2))

ratings <- dat_clean %>%
  transmute(
    obs1 = as.character(obs1),
    obs2 = as.character(obs2)
  )

k_res <- kappa2(ratings, weight = "unweighted")
print(k_res)

N  <- nrow(ratings)
PA <- mean(ratings$obs1 == ratings$obs2, na.rm = TRUE) * 100

print(list(
  kappa = round(k_res$value, 3),
  N = N,
  p_value = k_res$p.value,
  percent_agreement = round(PA, 2)
))








